---
import PageLayout from '../../layouts/PageLayout.astro';
import { apiUrl } from '../../lib/api';
// import galleryData from '../data/gallery.json';

interface GalleryItem {
  title?: string;
  url: string;
  date?: string;
  tags?: string[];
}

let gallery: GalleryItem[] = [];
let allTags: string[] = [];

try {
  const [galleryResponse, tagsResponse] = await Promise.all([
    fetch(apiUrl('/api/user/gallery?limit=100')),
    fetch(apiUrl('/api/user/gallery/tags'))
  ]);
  
  if (galleryResponse.ok) {
    gallery = await galleryResponse.json() as GalleryItem[];
  } else {
    console.error(`Failed to fetch gallery: ${galleryResponse.status} ${galleryResponse.statusText}`);
  }
  
  if (tagsResponse.ok) {
    const tagsData = await tagsResponse.json();
    allTags = tagsData.tags || [];
  }
} catch (error) {
  console.error('Failed to fetch gallery:', error);
}
---

<PageLayout title="Gallery | Nayuki Blog">
  <div class="container">
    <h1>图库</h1>
    <p>收集我喜欢的图片与摄影作品。</p>
    
    <!-- Tag Filter -->
    <div class="filter-section">
      <label>按标签筛选：</label>
      <div class="custom-select" id="tag-selector">
        <div class="select-trigger" id="select-trigger">
          <div class="selected-tags" id="selected-tags">
            <span class="placeholder">选择标签（最多3个）</span>
          </div>
          <svg class="select-arrow" width="12" height="12" viewBox="0 0 12 12">
            <path fill="#666" d="M6 8L1 3h10z"/>
          </svg>
        </div>
        <div class="select-options" id="select-options">
          {allTags.map((tag) => (
            <div class="select-option" data-value={tag}>
              <span class="checkbox"></span>
              <span>{tag}</span>
            </div>
          ))}
        </div>
      </div>
      <button class="clear-btn" id="clear-btn" style="display: none;">清除</button>
    </div>
    
    <div class="gallery-masonry" id="gallery-container">
      {gallery.map((item) => (
        <div class="gallery-item group" data-tags={JSON.stringify(item.tags || [])}>
          <img src={item.url} alt={item.title} loading="lazy" />
          <div class="overlay">
            <h3 class="image-title">{item.title}</h3>
            {item.tags && (
              <div class="tags">
                {item.tags.map((tag: string) => (
                  <span class="tag">#{tag}</span>
                ))}
              </div>
            )}
          </div>
        </div>
      ))}
    </div>
    
    <!-- Pagination -->
    <div class="pagination" id="pagination">
      <button class="page-btn" id="prev-btn" disabled>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M10.5 12.5L5.5 8l5-4.5" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        上一页
      </button>
      <div class="page-info">
        <span id="current-page">1</span> / <span id="total-pages">1</span>
      </div>
      <button class="page-btn" id="next-btn">
        下一页
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M5.5 3.5L10.5 8l-5 4.5" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</PageLayout>

<script>
  const selectTrigger = document.getElementById('select-trigger');
  const selectOptions = document.getElementById('select-options');
  const selectedTagsContainer = document.getElementById('selected-tags');
  const options = document.querySelectorAll('.select-option');
  const galleryItems = document.querySelectorAll('.gallery-item');
  const tagSelector = document.getElementById('tag-selector');
  const clearBtn = document.getElementById('clear-btn');
  
  // Pagination elements
  const prevBtn = document.getElementById('prev-btn') as HTMLButtonElement;
  const nextBtn = document.getElementById('next-btn') as HTMLButtonElement;
  const currentPageSpan = document.getElementById('current-page');
  const totalPagesSpan = document.getElementById('total-pages');

  let selectedTags: string[] = [];
  const MAX_TAGS = 3;
  const ITEMS_PER_PAGE = 10;
  let currentPage = 1;
  let filteredItems: HTMLElement[] = [];

  // Toggle dropdown
  selectTrigger?.addEventListener('click', (e) => {
    e.stopPropagation();
    tagSelector?.classList.toggle('open');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', () => {
    tagSelector?.classList.remove('open');
  });

  // Prevent closing when clicking inside options
  selectOptions?.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // Update the display of selected tags
  function updateSelectedDisplay() {
    if (!selectedTagsContainer) return;
    
    if (selectedTags.length === 0) {
      selectedTagsContainer.innerHTML = '<span class="placeholder">选择标签（最多3个）</span>';
      if (clearBtn) clearBtn.style.display = 'none';
    } else {
      selectedTagsContainer.innerHTML = selectedTags
        .map(tag => `<span class="selected-tag">${tag}<span class="remove-tag" data-tag="${tag}">×</span></span>`)
        .join('');
      if (clearBtn) clearBtn.style.display = 'inline-flex';
    }

    // Add remove handlers
    document.querySelectorAll('.remove-tag').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const tag = (btn as HTMLElement).dataset.tag;
        if (tag) {
          removeTag(tag);
        }
      });
    });
  }

  // Filter gallery items based on selected tags (AND logic)
  function filterGallery() {
    // First, filter items based on tags
    filteredItems = [];
    galleryItems.forEach((item) => {
      const element = item as HTMLElement;
      const tagsAttr = element.dataset.tags;
      const itemTags: string[] = tagsAttr ? JSON.parse(tagsAttr) : [];
      
      // AND logic: item must contain ALL selected tags
      const matchesAll = selectedTags.length === 0 || 
        selectedTags.every(tag => itemTags.includes(tag));
      
      if (matchesAll) {
        filteredItems.push(element);
      }
    });
    
    // Reset to first page when filter changes
    currentPage = 1;
    updatePagination();
  }
  
  // Update pagination display and show correct items
  function updatePagination() {
    const totalPages = Math.max(1, Math.ceil(filteredItems.length / ITEMS_PER_PAGE));
    
    // Ensure currentPage is within bounds
    if (currentPage > totalPages) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;
    
    // Update page info display
    if (currentPageSpan) currentPageSpan.textContent = String(currentPage);
    if (totalPagesSpan) totalPagesSpan.textContent = String(totalPages);
    
    // Update button states
    if (prevBtn) prevBtn.disabled = currentPage <= 1;
    if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
    
    // Calculate which items to show
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;
    
    // Hide all items first
    galleryItems.forEach((item) => {
      (item as HTMLElement).style.display = 'none';
    });
    
    // Show only items for current page
    filteredItems.forEach((item, index) => {
      if (index >= startIndex && index < endIndex) {
        item.style.display = '';
      }
    });
  }
  
  // Pagination button handlers
  prevBtn?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      updatePagination();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });
  
  nextBtn?.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);
    if (currentPage < totalPages) {
      currentPage++;
      updatePagination();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  // Remove a tag
  function removeTag(tag: string) {
    selectedTags = selectedTags.filter(t => t !== tag);
    // Update option checkbox state
    options.forEach(opt => {
      if ((opt as HTMLElement).dataset.value === tag) {
        opt.classList.remove('checked');
      }
    });
    updateSelectedDisplay();
    filterGallery();
  }

  // Clear all tags
  clearBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    selectedTags = [];
    options.forEach(opt => opt.classList.remove('checked'));
    updateSelectedDisplay();
    filterGallery();
  });

  // Handle option selection
  options.forEach((option) => {
    option.addEventListener('click', () => {
      const value = (option as HTMLElement).dataset.value || '';
      
      if (option.classList.contains('checked')) {
        // Deselect
        selectedTags = selectedTags.filter(t => t !== value);
        option.classList.remove('checked');
      } else {
        // Select (if under limit)
        if (selectedTags.length < MAX_TAGS) {
          selectedTags.push(value);
          option.classList.add('checked');
        }
      }
      
      updateSelectedDisplay();
      filterGallery();
    });
  });

  // Initialize
  updateSelectedDisplay();
  // Initialize filtered items with all items
  galleryItems.forEach((item) => {
    filteredItems.push(item as HTMLElement);
  });
  updatePagination();
</script>

<style is:global>
  .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
  
  /* Filter Section */
  .filter-section {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .filter-section label {
    font-size: 0.9rem;
    color: #666;
    white-space: nowrap;
  }

  /* Custom Select */
  .custom-select {
    position: relative;
    min-width: 360px;
  }

  .select-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    background-color: #fff;
    color: #333;
    cursor: pointer;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    min-height: 40px;
  }

  .select-trigger:hover {
    border-color: #ccc;
  }

  .custom-select.open .select-trigger {
    border-color: #333;
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
  }

  .selected-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    flex: 1;
    align-items: center;
  }

  .placeholder {
    color: #999;
    font-size: 0.85rem;
  }

  .selected-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    background: #f0f0f0;
    color: #333;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
  }

  .remove-tag {
    cursor: pointer;
    color: #999;
    font-size: 1rem;
    line-height: 1;
    margin-left: 0.2rem;
  }

  .remove-tag:hover {
    color: #666;
  }

  .select-arrow {
    transition: transform 0.2s ease;
    margin-left: 0.5rem;
    flex-shrink: 0;
  }

  .custom-select.open .select-arrow {
    transform: rotate(180deg);
  }

  .select-options {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    max-height: 240px;
    overflow-y: auto;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
  }

  .custom-select.open .select-options {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .select-option {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.6rem 1rem;
    font-size: 0.9rem;
    color: #333;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }

  .select-option:first-child {
    border-radius: 7px 7px 0 0;
  }

  .select-option:last-child {
    border-radius: 0 0 7px 7px;
  }

  .select-option:hover {
    background-color: #f5f5f5;
  }

  .select-option .checkbox {
    width: 16px;
    height: 16px;
    border: 1px solid #ccc;
    border-radius: 3px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
    flex-shrink: 0;
  }

  .select-option.checked .checkbox {
    background: #333;
    border-color: #333;
  }

  .select-option.checked .checkbox::after {
    content: '';
    width: 4px;
    height: 8px;
    border: solid #fff;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    margin-bottom: 2px;
  }

  .clear-btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
    border: 1px solid #e5e5e5;
    border-radius: 6px;
    background: #fff;
    color: #666;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
  }

  .clear-btn:hover {
    border-color: #ccc;
    color: #333;
  }

  /* Masonry Layout using CSS Columns */
  .gallery-masonry {
    column-count: 1;
    column-gap: 1rem;
  }

  @media (min-width: 640px) {
    .gallery-masonry {
      column-count: 2;
    }
  }

  @media (min-width: 1024px) {
    .gallery-masonry {
      column-count: 3;
    }
  }

  .gallery-item {
    break-inside: avoid;
    margin-bottom: 1rem;
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    transform: translateZ(0); /* Fix for some rendering issues */
  }

  .gallery-item img {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  .gallery-item:hover img {
    transform: scale(1.05);
  }

  /* Overlay Styles */
  .overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
    padding: 4rem 1.5rem 1.5rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
  }

  .gallery-item:hover .overlay {
    opacity: 1;
  }

  .image-title {
    color: #fff;
    margin: 0 0 0.8rem 0;
    font-size: 1.2rem;
    font-weight: 600;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    transform: translateY(10px);
    transition: transform 0.3s ease;
  }

  .gallery-item:hover .image-title {
    transform: translateY(0);
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    transform: translateY(10px);
    transition: transform 0.3s ease 0.1s; /* Slight delay */
  }

  .gallery-item:hover .tags {
    transform: translateY(0);
  }

  .tag {
    font-size: 0.75rem;
    color: #fff;
    background: rgba(255,255,255,0.25);
    padding: 0.25rem 0.7rem;
    border-radius: 99px;
    backdrop-filter: blur(4px);
    font-weight: 500;
  }

  /* Pagination Styles */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1.5rem;
    margin-top: 2rem;
    padding: 1.5rem 0;
  }

  .page-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1.2rem;
    font-size: 0.9rem;
    font-weight: 500;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    background: #fff;
    color: #333;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .page-btn:hover:not(:disabled) {
    border-color: #333;
    background: #fafafa;
  }

  .page-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .page-btn svg {
    width: 16px;
    height: 16px;
  }

  .page-info {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.95rem;
    color: #666;
    font-weight: 500;
  }

  .page-info #current-page {
    color: #333;
    font-weight: 600;
  }
</style>
