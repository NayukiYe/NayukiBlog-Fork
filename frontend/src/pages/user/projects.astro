---
import PageLayout from '../../layouts/PageLayout.astro';
import ProjectCard from '../../components/User/projects/ProjectCard.astro';
// import projectsData from '../data/projects.json';

interface Project {
  name: string;
  description: string;
  link: string;
  techStack: string[];
  image: string;
  status: string;
}

let projects: Project[] = [];
try {
  const apiBase = import.meta.env.SSR ? 'http://127.0.0.1:8000' : '';
  const response = await fetch(`${apiBase}/api/user/projects`);
  if (response.ok) {
    projects = await response.json() as Project[];
  } else {
    console.error(`Failed to fetch projects: ${response.status} ${response.statusText}`);
  }
} catch (error) {
  console.error('Failed to fetch projects:', error);
}

// Helper to map data format
const mapProject = (p: Project) => ({
  title: p.name,
  desc: p.description,
  url: p.link,
  tech: p.techStack
});

const inProgressProjects = projects.filter(p => p.status === 'in-progress').map(mapProject);
const completedProjects = projects.filter(p => p.status === 'completed').map(mapProject);
const planningProjects = projects.filter(p => p.status === 'planning').map(mapProject);
---

<PageLayout title="Projects | Nayuki Blog">
  <div class="page-container">
    <h1 class="page-title">å¼€æºé¡¹ç›®</h1>
    <p class="page-desc">è¿™é‡Œå±•ç¤ºäº†æˆ‘çš„ä¸€äº›å¼€æºé¡¹ç›®å’Œå®éªŒæ€§ä½œå“ã€‚</p>
    
    <div class="sections-wrapper">
      
      <!-- In Progress -->
      {inProgressProjects.length > 0 && (
        <section class="project-section">
          <h2 class="section-title">ğŸš§ æ­£åœ¨è¿›è¡Œ (In Progress)</h2>
          <div class="project-grid">
            {inProgressProjects.map(project => (
              <ProjectCard {...project} />
            ))}
          </div>
        </section>
      )}

      <!-- Completed -->
      {completedProjects.length > 0 && (
        <section class="project-section">
          <h2 class="section-title">âœ… å·²å®Œæˆ (Completed)</h2>
          <div class="project-grid">
            {completedProjects.map(project => (
              <ProjectCard {...project} />
            ))}
          </div>
        </section>
      )}

      <!-- Planning -->
      {planningProjects.length > 0 && (
        <section class="project-section">
          <h2 class="section-title">ğŸ’¡ æ­£åœ¨æ–°å»ºä»“åº“ (Planning)</h2>
          <div class="project-grid">
            {planningProjects.map(project => (
              <ProjectCard {...project} />
            ))}
          </div>
        </section>
      )}

    </div>
  </div>
</PageLayout>

<style>
  .page-container { max-width: 960px; margin: 0 auto; }
  .page-title { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
  .page-desc { color: #666; margin-bottom: 3rem; }
  
  .sections-wrapper {
    display: flex;
    flex-direction: column;
    gap: 4rem;
  }

  .section-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
  }

  .project-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
  @media (min-width: 640px) { .project-grid { grid-template-columns: repeat(2, 1fr); } }
</style>
