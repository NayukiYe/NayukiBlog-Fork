---
import PageLayout from '../../layouts/PageLayout.astro';
import TaskCard from '../../components/User/TaskCard.astro';
import { apiUrl } from '../../lib/api';
// import todosData from '../data/todos.json';

interface Todo {
  id: number;
  task: string;
  completed: boolean;
  priority: string;
  type: string;
  progress: number;
  icon: string;
}

let todos: Todo[] = [];
try {
  const response = await fetch(apiUrl('/api/user/todos'));
  if (response.ok) {
    todos = await response.json() as Todo[];
  } else {
    console.error(`Failed to fetch todos: ${response.status} ${response.statusText}`);
  }
} catch (error) {
  console.error('Failed to fetch todos:', error);
}

const completedTodos = todos.filter(t => t.completed);
const activeTodos = todos.filter(t => !t.completed);

const shortTerm = activeTodos.filter(t => t.type === 'short-term');
const mediumTerm = activeTodos.filter(t => t.type === 'medium-term');
const longTerm = activeTodos.filter(t => t.type === 'long-term');
---

<PageLayout title="TODO List | Nayuki Blog">
  <div class="container" id="todo-container">
    <div class="header-row">
      <div>
        <h1 class="page-title">ä»»åŠ¡ç®¡ç†</h1>
        <p class="page-desc">è§„åˆ’ä¸è¿½è¸ªä¸ªäººç›®æ ‡ã€‚</p>
      </div>
    </div>

    <!-- Layer 1: Completed Tasks (Collapsible) -->
    {completedTodos.length > 0 && (
      <details class="completed-section">
        <summary>å·²å®Œæˆä»»åŠ¡ ({completedTodos.length})</summary>
        <div class="task-grid mt-4">
          {completedTodos.map(todo => <TaskCard {...todo} />)}
        </div>
      </details>
    )}

    <div class="todo-layers">
      <!-- Layer 2: Short Term -->
      <section class="layer-section">
        <h2 class="layer-title">ğŸš€ çŸ­æœŸç›®æ ‡ (Short-term)</h2>
        <div class="task-grid">
          {shortTerm.map(todo => <TaskCard {...todo} />)}
        </div>
      </section>

      <!-- Layer 3: Medium Term -->
      <section class="layer-section">
        <h2 class="layer-title">ğŸ“… ä¸­æœŸç›®æ ‡ (Medium-term)</h2>
        <div class="task-grid">
          {mediumTerm.map(todo => <TaskCard {...todo} />)}
        </div>
      </section>

      <!-- Layer 4: Long Term -->
      <section class="layer-section">
        <h2 class="layer-title">ğŸ”ï¸ é•¿æœŸç›®æ ‡ (Long-term)</h2>
        <div class="task-grid">
          {longTerm.map(todo => <TaskCard {...todo} />)}
        </div>
      </section>
    </div>
  </div>
</PageLayout>

<style>
  .container { max-width: 1000px; margin: 0 auto; }
  
  .header-row {
    margin-bottom: 2rem;
  }

  .page-title { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
  .page-desc { color: #666; margin: 0; }

  /* Completed Section Styles */
  .completed-section {
    margin-bottom: 3rem;
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 0.5rem;
    background: #fafafa;
  }

  .completed-section summary {
    cursor: pointer;
    padding: 0.5rem;
    font-weight: 500;
    color: #666;
    user-select: none;
  }

  .completed-section summary:hover {
    color: #333;
  }

  .mt-4 { margin-top: 1rem; }

  .layer-section {
    margin-bottom: 4rem;
  }

  .layer-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
    color: #333;
  }

  .task-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  @media (min-width: 640px) {
    .task-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .task-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>
