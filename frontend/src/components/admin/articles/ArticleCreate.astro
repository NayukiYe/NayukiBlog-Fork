---
// ArticleCreate.astro
import AlertModal from '../AlertModal.astro';
---

<div id="create-article-modal" class="modal-overlay hidden">
  <div class="modal-card">
    <div class="modal-header">
      <h3 class="modal-title">Create New Article</h3>
      <button class="close-btn">&times;</button>
    </div>

    <div class="modal-body">
      <form id="create-article-form" class="create-form">
        
        <!-- 1. Upload File -->
        <div class="form-group">
          <label class="form-label">Upload Markdown File</label>
          <div class="file-upload-wrapper">
            <input type="file" id="article-file" name="file" accept=".md" class="file-input" />
            <div class="file-upload-placeholder">
              <i class="fas fa-cloud-upload-alt"></i>
              <span>Click to upload or drag and drop</span>
            </div>
          </div>
        </div>

        <!-- 2. Folder Selection -->
        <div class="form-group">
          <div class="folder-header">
            <label class="form-label">Folder</label>
            <button type="button" class="btn-icon-small" title="Create New Folder">
              <i class="fas fa-folder-plus"></i>
            </button>
          </div>
          <div class="folder-tree-container">
            <input type="hidden" name="folder" id="selected-folder-input" />
            <div class="folder-tree" id="create-folder-tree">
            </div>
          </div>
        </div>

        <!-- 3. Title -->
        <div class="form-group">
          <label class="form-label">Title</label>
          <input type="text" name="title" class="form-input" placeholder="Article Title" />
        </div>

        <!-- 4. Tags -->
        <div class="form-group">
          <label class="form-label">Tags</label>
          <div class="tags-input-container">
            <div class="selected-tags">
              <!-- Tags will be added here -->
            </div>
            <div class="tag-input-wrapper">
                <input type="text" class="tag-input" placeholder="Add tag" />
                <div class="tag-controls">
                    <button type="button" class="tag-control-btn confirm-tag-btn" title="Add tag">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
                <div class="tags-dropdown hidden">
                  <!-- Tag suggestions -->
                </div>
            </div>
          </div>
        </div>

        <div class="form-row">
          <!-- 5. Status -->
          <div class="form-group half">
            <label class="form-label">Status</label>
            <div class="custom-select-wrapper" id="articleStatusWrapper">
              <div class="custom-select-trigger" id="articleStatusTrigger">
                <span class="current-text">Draft</span>
                <input type="hidden" name="status" value="draft">
                <i class="fas fa-chevron-down arrow-icon"></i>
              </div>
              <div class="custom-options hidden" id="articleStatusOptions">
                <div class="custom-option selected" data-value="draft">Draft</div>
                <div class="custom-option" data-value="public">Published</div>
                <div class="custom-option" data-value="private">Private</div>
              </div>
            </div>
          </div>

          <!-- 6. Date -->
          <div class="form-group half">
            <label class="form-label">Date</label>
            <input type="date" name="date" class="form-input" />
          </div>
        </div>

      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-cancel close-btn">Cancel</button>
      <button class="btn btn-confirm">Confirm</button>
    </div>
  </div>
</div>

<!-- New Folder Modal -->
<div id="new-folder-modal" class="modal-overlay hidden" style="z-index: 2100;">
  <div class="modal-card" style="width: 600px; height: auto; max-height: 80vh;">
    <div class="modal-header">
      <h3 class="modal-title">Create New Folder</h3>
      <button class="close-new-folder-btn close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Select Parent Folder</label>
        <div class="folder-tree-container" style="height: 200px;">
          <div class="folder-tree" id="parent-folder-tree">
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">New Folder Name</label>
        <input type="text" id="new-folder-name" class="form-input" placeholder="e.g. tutorials" />
      </div>
      <div class="folder-preview-text" style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; line-height: 1.4;">
        Selected Parent: <span id="selected-parent-display" style="font-weight: 600;">(Root)</span><br>
        Creating Directory: <span id="new-path-display" style="color: #0066cc;">/</span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancel close-new-folder-btn">Cancel</button>
      <button class="btn btn-confirm" id="confirm-new-folder">Create</button>
    </div>
  </div>
</div>

<AlertModal />

<style>
  :global(.modal-overlay) {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    backdrop-filter: blur(2px);
  }

  :global(.modal-overlay.hidden) {
    display: none;
  }

  :global(.modal-card) {
    background: #fff;
    border-radius: 12px;
    width: 600px;
    max-width: 90%;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    max-height: 90vh;
    animation: modal-slide-in 0.3s ease;
  }

  @keyframes modal-slide-in {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  :global(.modal-header) {
    padding: 1.5rem;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  :global(.modal-title) {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #333;
  }

  :global(.close-btn) {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #999;
    cursor: pointer;
    padding: 0;
    line-height: 1;
    transition: color 0.2s;
  }

  :global(.close-btn:hover) {
    color: #333;
  }

  :global(.modal-body) {
    padding: 1.5rem;
    overflow-y: auto;
  }

  :global(.create-form) {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  :global(.form-group) {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  :global(.form-row) {
    display: flex;
    gap: 1rem;
  }

  :global(.form-group.half) {
    flex: 1;
  }

  :global(.form-label) {
    font-size: 0.9rem;
    font-weight: 500;
    color: #555;
  }

  :global(.form-input), :global(.form-select) {
    padding: 0.6rem 0.8rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
    width: 100%;
    box-sizing: border-box;
    height: 42px; /* Fixed height for consistency */
    font-family: inherit;
  }

  :global(.form-input:focus), :global(.form-select:focus) {
    border-color: #000;
    outline: none;
  }

  /* Custom Select Styles */
  :global(.custom-select-wrapper) {
    position: relative;
  }

  :global(.custom-select-trigger) {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0 0.8rem;
    cursor: pointer;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: border-color 0.2s;
    font-size: 0.95rem;
    color: #333;
    box-sizing: border-box;
    height: 42px; /* Fixed height */
  }

  :global(.custom-select-trigger:hover) {
    border-color: #000;
  }

  :global(.custom-options) {
    position: absolute;
    bottom: 100%; /* Open upwards */
    margin-bottom: 6px;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 4px;
  }

  :global(.custom-options.hidden) {
    display: none;
  }

  :global(.custom-option) {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.9rem;
    color: #444;
    transition: all 0.2s;
    border-radius: 4px;
  }

  :global(.custom-option:hover) {
    background: #f5f5f7;
    color: #000;
  }

  :global(.custom-option.selected) {
    background: #f0f7ff;
    color: #0066cc;
    font-weight: 500;
  }

  :global(.arrow-icon) {
    color: #999;
    font-size: 0.8rem;
    pointer-events: none;
  }

  /* File Upload Styling */
  :global(.file-upload-wrapper) {
    position: relative;
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.2s;
    background: #fafafa;
    cursor: pointer;
  }

  :global(.file-upload-wrapper:hover) {
    border-color: #666;
    background: #f0f0f0;
  }

  :global(.file-input) {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }

  :global(.file-upload-placeholder) {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: #888;
    pointer-events: none;
  }

  :global(.file-upload-placeholder i) {
    font-size: 2rem;
    color: #ccc;
  }

  :global(.file-upload-wrapper:hover .file-upload-placeholder i) {
    color: #666;
  }

  /* Folder Tree Styling */
  :global(.folder-header) {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  :global(.btn-icon-small) {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  :global(.btn-icon-small:hover) {
    background: #f0f0f0;
    color: #000;
  }

  :global(.folder-tree-container) {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
    background: #fff;
  }

  :global(.folder-tree) {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  :global(.folder-item) {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  :global(.folder-toggle) {
    background: none;
    border: none;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #999;
    transition: color 0.2s;
  }

  :global(.folder-toggle:hover) {
    color: #333;
  }

  :global(.toggle-icon) {
    transition: transform 0.2s;
  }

  :global(.folder-spacer) {
    width: 20px;
    display: inline-block;
  }

  :global(.folder-btn) {
    flex: 1;
    background: none;
    border: none;
    text-align: left;
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 4px;
    color: #444;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
  }

  :global(.folder-btn:hover) {
    background: #f5f5f7;
    color: #000;
  }

  :global(.folder-btn.active) {
    background: #f0f7ff;
    color: #0066cc;
    font-weight: 500;
  }

  :global(.folder-icon) {
    color: #999;
  }

  :global(.folder-btn.active .folder-icon) {
    color: #0066cc;
  }

  /* Date Input Fix */
  :global(input[type="date"].form-input) {
    appearance: none; /* Standard property */
    -webkit-appearance: none; /* Safari/Chrome */
    -moz-appearance: none; /* Firefox */
    display: block;
    font-family: inherit;
    line-height: 1.5;
    background-color: #fff;
    color: #333;
    cursor: text;
    position: relative;
  }

  /* Custom Calendar Icon for Webkit */
  :global(input[type="date"].form-input::-webkit-calendar-picker-indicator) {
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s;
    padding: 4px;
  }

  :global(input[type="date"].form-input::-webkit-calendar-picker-indicator:hover) {
    opacity: 1;
  }

  /* Tags Input Styling */
  :global(.tags-input-container) {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0.4rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    background: #fff;
    position: relative;
    min-height: 42px;
    box-sizing: border-box;
  }

  :global(.tags-input-container:focus-within) {
    border-color: #000;
  }

  :global(.selected-tags) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  :global(.tag) {
    background: #f0f0f0;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    color: #333;
  }

  :global(.tag i) {
    cursor: pointer;
    font-size: 0.8rem;
    color: #999;
    transition: color 0.2s;
  }

  :global(.tag i:hover) {
    color: #d32f2f;
  }

  :global(.tag-input) {
    border: none;
    outline: none;
    flex: 1;
    min-width: 80px;
    font-size: 0.95rem;
    padding: 0.2rem;
    padding-right: 30px !important; /* Space for button */
    background: transparent;
  }

  :global(.tag-input-wrapper) {
      display: flex;
      position: relative;
      align-items: center;
  }

  :global(#create-article-form .tag-input-wrapper) {
      flex: 1;
  }

  :global(.tag-controls) {
      position: absolute;
      right: 4px;
      display: flex;
      gap: 2px;
      top: 50%;
      transform: translateY(-50%);
  }

  :global(.tag-control-btn) {
      background: none;
      border: none;
      color: #aaa;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      font-size: 0.8rem;
      transition: all 0.2s;
  }

  :global(.tag-control-btn:hover) {
      background: #f0f0f0;
      color: #333;
  }

  :global(.confirm-tag-btn) {
      color: #28a745;
  }

  :global(.confirm-tag-btn:hover) {
      background: #e6f4ea;
      color: #1e7e34;
  }

  :global(.tags-dropdown) {
    position: absolute;
    bottom: 100%; /* Flip up */
    left: 0;
    width: 100%;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 100;
    margin-bottom: 4px;
    max-height: 200px; /* Fixed height */
    overflow-y: auto; /* Scrollable */
  }
  
  :global(.tags-dropdown.hidden) {
    display: none;
  }

  :global(.selected-tags) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    align-items: center;
  }

  :global(.modal-footer) {
    padding: 1.5rem;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
  }

  :global(.btn) {
    padding: 0.6rem 1.5rem;
    border-radius: 6px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  :global(.btn-cancel) {
    background: #fff;
    border: 1px solid #ddd;
    color: #555;
  }

  :global(.btn-cancel:hover) {
    background: #f5f5f5;
    color: #333;
  }

  :global(.btn-confirm) {
    background: #000;
    border: 1px solid #000;
    color: #fff;
  }

  :global(.btn-confirm:hover) {
    background: #333;
    border-color: #333;
  }
</style>

<script>
  const modal = document.getElementById('create-article-modal');
  
  // --- Tags Logic ---
  const tagsContainer = document.querySelector('.tags-input-container');
  const tagsInput = tagsContainer?.querySelector('.tag-input') as HTMLInputElement;
  const tagsDropdown = tagsContainer?.querySelector('.tags-dropdown');
  const selectedTagsContainer = tagsContainer?.querySelector('.selected-tags');
  const confirmTagBtn = tagsContainer?.querySelector('.confirm-tag-btn');
  
  let availableTags: string[] = [];
  let selectedTags: string[] = [];
  const MAX_TAGS = 3;

  async function fetchTags() {
    try {
      const res = await fetch('http://127.0.0.1:8000/api/admin/articles/tags');
      if (res.ok) {
        const data = await res.json();
        availableTags = data.tags || [];
        console.log('Fetched tags:', availableTags);
      }
    } catch (e) {
      console.error('Failed to fetch tags', e);
    }
  }

  function renderSelectedTags() {
    if (!selectedTagsContainer) return;
    selectedTagsContainer.innerHTML = selectedTags.map(tag => `
      <span class="tag">
        ${tag}
        <i class="fas fa-times" data-tag="${tag}" style="cursor: pointer; margin-left: 4px;"></i>
      </span>
    `).join('');
    
    if (tagsInput) {
        if (selectedTags.length >= MAX_TAGS) {
            tagsInput.style.display = 'none';
            if (confirmTagBtn) (confirmTagBtn as HTMLElement).style.display = 'none';
        } else {
            tagsInput.style.display = 'block';
            if (confirmTagBtn) (confirmTagBtn as HTMLElement).style.display = 'flex';
            tagsInput.placeholder = selectedTags.length > 0 ? 'Add another...' : 'Add tag';
        }
    }
  }

  function addTag(tag: string) {
      tag = tag.trim();
      if (tag && !selectedTags.includes(tag) && selectedTags.length < MAX_TAGS) {
          selectedTags.push(tag);
          renderSelectedTags();
          if (tagsInput) {
              tagsInput.value = '';
              tagsInput.focus();
          }
          if (tagsDropdown) tagsDropdown.classList.add('hidden');
      }
  }

  function removeTag(tag: string) {
      selectedTags = selectedTags.filter(t => t !== tag);
      renderSelectedTags();
  }

  // Event Delegation for removing tags
  selectedTagsContainer?.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.classList.contains('fa-times')) {
          const tag = target.getAttribute('data-tag');
          if (tag) removeTag(tag);
      }
  });

  // Button Handlers
  confirmTagBtn?.addEventListener('mousedown', (e) => e.preventDefault()); // Prevent blur
  confirmTagBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      if (tagsInput && tagsInput.value) {
          addTag(tagsInput.value);
      }
  });

  // Input Events
  tagsInput?.addEventListener('input', (e) => {
      const val = (e.target as HTMLInputElement).value.trim();
      if (val) {
          const matches = availableTags.filter(t => 
              t.toLowerCase().includes(val.toLowerCase()) && !selectedTags.includes(t)
          );
          renderDropdown(matches);
      } else {
          // Show all if input cleared
          const suggestions = availableTags.filter(t => !selectedTags.includes(t));
          renderDropdown(suggestions);
      }
  });

  tagsInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
          e.preventDefault();
          const val = tagsInput.value;
          if (val) addTag(val);
      } else if (e.key === 'Backspace' && !tagsInput.value && selectedTags.length > 0) {
          removeTag(selectedTags[selectedTags.length - 1]);
      }
  });

  tagsInput?.addEventListener('focus', () => {
      const val = tagsInput.value.trim();
      let suggestions = [];
      if (val) {
          suggestions = availableTags.filter(t => 
              t.toLowerCase().includes(val.toLowerCase()) && !selectedTags.includes(t)
          );
      } else {
          suggestions = availableTags.filter(t => !selectedTags.includes(t));
      }
      renderDropdown(suggestions);
  });

  tagsInput?.addEventListener('click', () => {
      if (tagsDropdown?.classList.contains('hidden')) {
          const val = tagsInput.value.trim();
          let suggestions = [];
          if (val) {
              suggestions = availableTags.filter(t => 
                  t.toLowerCase().includes(val.toLowerCase()) && !selectedTags.includes(t)
              );
          } else {
              suggestions = availableTags.filter(t => !selectedTags.includes(t));
          }
          renderDropdown(suggestions);
      }
  });

  // Blur handling
  tagsInput?.addEventListener('blur', () => {
      // Delay to allow click on dropdown
      setTimeout(() => {
          tagsDropdown?.classList.add('hidden');
      }, 200);
  });

  function renderDropdown(tags: string[]) {
      if (!tagsDropdown) return;
      if (tags.length === 0) {
          tagsDropdown.classList.add('hidden');
          return;
      }
      
      tagsDropdown.innerHTML = tags.map(tag => `
          <div class="custom-option">${tag}</div>
      `).join('');
      tagsDropdown.classList.remove('hidden');
  }

  tagsDropdown?.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.classList.contains('custom-option')) {
          addTag(target.textContent || '');
      }
  });

  // Folder Tree Logic
  const folderTreeContainer = document.getElementById('create-folder-tree');
  const folderInput = document.getElementById('selected-folder-input') as HTMLInputElement;
  const newFolderBtn = document.querySelector('.btn-icon-small[title="Create New Folder"]');
  
  // New Folder Modal Elements
  const newFolderModal = document.getElementById('new-folder-modal');
  const parentFolderTreeContainer = document.getElementById('parent-folder-tree');
  const newFolderNameInput = document.getElementById('new-folder-name') as HTMLInputElement;
  const selectedParentDisplay = document.getElementById('selected-parent-display');
  const newPathDisplay = document.getElementById('new-path-display');
  const confirmNewFolderBtn = document.getElementById('confirm-new-folder');
  
  let collapsedFolders = new Set<string>();
  let cachedCategories: any[] = []; // Cache categories to avoid re-fetching
  let selectedParentPath = '';

  interface CategoryNode {
      path: string;
      label: string;
      children: CategoryNode[];
      hasChildren?: boolean;
  }

  // New Folder Button Logic
  newFolderBtn?.addEventListener('click', () => {
      newFolderModal?.classList.remove('hidden');
      // Reset state
      selectedParentPath = '';
      if (newFolderNameInput) newFolderNameInput.value = '';
      updateNewFolderPreview();
      
      // Render parent tree
      if (cachedCategories.length > 0) {
          const tree = buildTree(cachedCategories);
          renderTree(tree, parentFolderTreeContainer, 0, (path) => {
              selectedParentPath = path;
              updateNewFolderPreview();
          });
      } else {
          // Fallback if cache empty (shouldn't happen if main modal opened first)
          fetchAndRenderFolders().then(() => {
             const tree = buildTree(cachedCategories);
             renderTree(tree, parentFolderTreeContainer, 0, (path) => {
                  selectedParentPath = path;
                  updateNewFolderPreview();
             });
          });
      }
  });

  // Close New Folder Modal
  newFolderModal?.querySelectorAll('.close-new-folder-btn').forEach(btn => {
      btn.addEventListener('click', () => {
          newFolderModal.classList.add('hidden');
      });
  });

  // Update Preview Text
  function updateNewFolderPreview() {
      const name = newFolderNameInput?.value.trim() || '';
      if (selectedParentDisplay) selectedParentDisplay.textContent = selectedParentPath || '(Root)';
      
      let fullPath = '';
      if (selectedParentPath) {
          fullPath = name ? `${selectedParentPath}/${name}` : `${selectedParentPath}/...`;
      } else {
          fullPath = name ? name : '...';
      }
      
      if (newPathDisplay) newPathDisplay.textContent = fullPath;
  }

  newFolderNameInput?.addEventListener('input', updateNewFolderPreview);

  // Confirm Create Folder
  confirmNewFolderBtn?.addEventListener('click', () => {
      const name = newFolderNameInput?.value.trim();
      if (!name) {
          window.showAdminAlert('Please enter a folder name (请输入文件夹名称)');
          return;
      }
      
      const fullPath = selectedParentPath ? `${selectedParentPath}/${name}` : name;
      
      // Simulate creation (In real app, POST to API)
      // Add to cache and re-render both trees
      cachedCategories.push({ path: fullPath });
      
      // Re-render main tree
      const tree = buildTree(cachedCategories);
      renderTree(tree, folderTreeContainer, 0, (path) => {
          if (folderInput) folderInput.value = path;
      });
      
      // Select the new folder in the main tree
      if (folderInput) folderInput.value = fullPath;
      // Trigger click on the new item to highlight it (after a brief delay for render)
      setTimeout(() => {
          const newItem = folderTreeContainer?.querySelector(`.folder-btn[data-folder="${fullPath}"]`) as HTMLElement;
          if (newItem) newItem.click();
      }, 50);

      newFolderModal?.classList.add('hidden');
  });

  async function fetchAndRenderFolders() {
    try {
      const response = await fetch('http://127.0.0.1:8000/api/admin/articles?limit=1000');
      if (response.ok) {
        const posts = await response.json();
        cachedCategories = posts
            .map((p: any) => ({ path: p.folder }))
            .filter((c: any) => c.path);
        
        const tree = buildTree(cachedCategories);
        renderTree(tree, folderTreeContainer, 0, (path) => {
            if (folderInput) folderInput.value = path;
        });
      }
    } catch (e) {
      console.error('Failed to fetch folders', e);
      if (folderTreeContainer) folderTreeContainer.innerHTML = '<div class="error-text">Failed to load folders</div>';
    }
  }

  function buildTree(categories: any[]): CategoryNode[] {
      const root: CategoryNode[] = [];
      const map = new Map<string, CategoryNode>();

      // Filter valid categories
      const validCats = categories.filter(c => c.path && !c.path.includes('error'));

      // Create nodes for all paths
      const allPaths = new Set<string>();
      validCats.forEach(c => {
          const parts = c.path.split('/');
          let current = '';
          parts.forEach((p: any) => {
              if(!p) return;
              current = current ? `${current}/${p}` : p;
              allPaths.add(current);
          });
      });

      const sortedPaths = Array.from(allPaths).sort();

      sortedPaths.forEach(path => {
          const parts = path.split('/');
          const label = parts[parts.length - 1];
          const parentPath = parts.slice(0, -1).join('/');
          
          const node: CategoryNode = { 
              path, 
              label, 
              children: [],
              hasChildren: false
          };
          map.set(path, node);

          if (parentPath && map.has(parentPath)) {
              const parent = map.get(parentPath)!;
              parent.children.push(node);
              parent.hasChildren = true;
          } else {
              root.push(node);
          }
      });

      return root;
  }

  function renderTree(
      nodes: CategoryNode[], 
      container: HTMLElement | null = null, 
      level: number = 0,
      onSelect?: (path: string) => void
  ) {
      const targetContainer = container || folderTreeContainer;
      if (!targetContainer) return;
      
      if (level === 0) targetContainer.innerHTML = ''; // Clear if root

      if (nodes.length === 0) {
          if (level === 0) targetContainer.innerHTML = '<div class="empty-text">No folders found</div>';
          return;
      }

      nodes.forEach(node => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'folder-item';
          itemDiv.dataset.path = node.path;
          itemDiv.style.paddingLeft = `${level * 1}rem`;

          // Toggle button for folders with children
          if (node.hasChildren) {
              const toggleBtn = document.createElement('button');
              toggleBtn.className = 'folder-toggle';
              toggleBtn.type = 'button';
              toggleBtn.dataset.target = node.path;
              toggleBtn.innerHTML = `
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="toggle-icon">
                      <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
              `;
              toggleBtn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  const icon = toggleBtn.querySelector('.toggle-icon') as HTMLElement;
                  const isCollapsed = collapsedFolders.has(node.path);
                  
                  if (isCollapsed) {
                      collapsedFolders.delete(node.path);
                      icon.style.transform = 'rotate(0deg)';
                  } else {
                      collapsedFolders.add(node.path);
                      icon.style.transform = 'rotate(-90deg)';
                  }
                  
                  toggleChildrenVisibility(node.path, targetContainer);
              });
              itemDiv.appendChild(toggleBtn);
          } else {
              const spacer = document.createElement('span');
              spacer.className = 'folder-spacer';
              itemDiv.appendChild(spacer);
          }

          // Folder button
          const folderBtn = document.createElement('button');
          folderBtn.className = 'folder-btn';
          folderBtn.type = 'button';
          folderBtn.dataset.folder = node.path;
          
          // Check if active (logic depends on context, handled by click mostly)
          // For initial render, we might want to check against current value, but let's keep it simple
          
          folderBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="folder-icon">
                  <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
              ${node.label}
          `;
          
          folderBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const allBtns = targetContainer?.querySelectorAll('.folder-btn');
              allBtns?.forEach(btn => btn.classList.remove('active'));
              folderBtn.classList.add('active');
              
              if (onSelect) {
                  onSelect(node.path);
              }
          });
          
          itemDiv.appendChild(folderBtn);
          targetContainer.appendChild(itemDiv);

          // Render children
          if (node.children.length > 0) {
              renderTree(node.children, targetContainer, level + 1, onSelect);
          }
      });
  }

  function toggleChildrenVisibility(parentPath: string, container: HTMLElement) {
      const allItems = container?.querySelectorAll('.folder-item[data-path]');
      const isCollapsed = collapsedFolders.has(parentPath);
      
      allItems?.forEach(item => {
          const path = (item as HTMLElement).dataset.path || '';
          if (path.startsWith(parentPath + '/') && path !== parentPath) {
              (item as HTMLElement).style.display = isCollapsed ? 'none' : 'flex';
          }
      });
  }

  // Initialize folders when modal opens
  document.addEventListener('open-create-article-modal', () => {
    modal?.classList.remove('hidden');
    fetchAndRenderFolders();
    // Reset Tags
    fetchTags();
    selectedTags = [];
    renderSelectedTags();
    if (tagsInput) tagsInput.value = '';
  });

  // Close Modal Events
  modal?.querySelectorAll('.close-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      modal.classList.add('hidden');
    });
  });

  // Close on click outside
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
    }
  });

  // Status Dropdown Logic
  const statusWrapper = document.getElementById('articleStatusWrapper');
  const statusTrigger = document.getElementById('articleStatusTrigger');
  const statusOptions = document.getElementById('articleStatusOptions');
  const statusInput = statusTrigger?.querySelector('input');
  const statusText = statusTrigger?.querySelector('.current-text');

  statusTrigger?.addEventListener('click', (e) => {
    e.stopPropagation();
    statusOptions?.classList.toggle('hidden');
  });

  statusOptions?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.classList.contains('custom-option')) {
      const value = target.getAttribute('data-value');
      const text = target.textContent;
      
      statusOptions.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
      target.classList.add('selected');
      if (statusText) statusText.textContent = text;
      if (statusInput) statusInput.value = value || '';
      
      statusOptions.classList.add('hidden');
    }
  });

  document.addEventListener('click', (e) => {
    if (!statusWrapper?.contains(e.target as Node)) {
      statusOptions?.classList.add('hidden');
    }
  });

  // File Input Change Listener
  const fileInput = document.getElementById('article-file') as HTMLInputElement;
  const filePlaceholder = document.querySelector('.file-upload-placeholder');
  
  fileInput?.addEventListener('change', () => {
      if (fileInput.files && fileInput.files.length > 0) {
          const file = fileInput.files[0];
          if (filePlaceholder) {
              filePlaceholder.innerHTML = `
                  <i class="fas fa-file-markdown" style="color: #0066cc;"></i>
                  <span style="color: #333; font-weight: 500;">${file.name}</span>
                  <span style="font-size: 0.8rem; color: #666;">(Click to change)</span>
              `;
          }
          
          // Auto-fill title if empty
          const titleInput = document.querySelector('input[name="title"]') as HTMLInputElement;
          if (titleInput && !titleInput.value) {
              // Remove extension and replace dashes/underscores with spaces
              let title = file.name.replace(/\.md$/i, '');
              title = title.replace(/[-_]/g, ' ');
              // Capitalize first letter of each word
              title = title.replace(/\b\w/g, l => l.toUpperCase());
              titleInput.value = title;
          }
      } else {
          // Reset placeholder
          if (filePlaceholder) {
              filePlaceholder.innerHTML = `
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span>Click to upload or drag and drop</span>
              `;
          }
      }
  });

  // Confirm Create Article
  const confirmBtn = modal?.querySelector('.btn-confirm');
  confirmBtn?.addEventListener('click', async () => {
      const form = document.getElementById('create-article-form') as HTMLFormElement;
      if (!form) return;

      const formData = new FormData(form);
      
      // Handle tags manually
      formData.append('tags', JSON.stringify(selectedTags));
      
      // Map folder to category for backend
      const folderVal = formData.get('folder');
      if (folderVal) {
          formData.append('category', folderVal);
      }

      // Validate required fields
      
      // 1. File
      const fileInput = document.getElementById('article-file') as HTMLInputElement;
      if (!fileInput.files || fileInput.files.length === 0) {
          window.showAdminAlert('Please upload a markdown file (请上传 Markdown 文件)');
          return;
      }

      // 2. Folder
      if (!folderVal) {
          window.showAdminAlert('Please select a folder (请选择文件夹)');
          return;
      }
      
      // 3. Title
      const titleInput = form.querySelector('input[name="title"]') as HTMLInputElement;
      if (!titleInput.value.trim()) {
          window.showAdminAlert('Please enter a title (请输入标题)');
          return;
      }

      // 4. Tags
      if (selectedTags.length === 0) {
          window.showAdminAlert('Please add at least one tag (请至少添加一个标签)');
          return;
      }

      // 5. Date
      const dateInput = form.querySelector('input[name="date"]') as HTMLInputElement;
      if (!dateInput.value) {
          window.showAdminAlert('Please select a date (请选择日期)');
          return;
      }

      try {
          const response = await fetch('http://127.0.0.1:8000/api/admin/articles/upload', {
              method: 'POST',
              body: formData
          });
          
          if (response.ok) {
              window.showAdminAlert('Article created successfully', 'success');
              setTimeout(() => {
                  modal?.classList.add('hidden');
                  window.location.reload();
              }, 1500);
          } else {
              const errorData = await response.json();
              window.showAdminAlert('Failed to create article: ' + (errorData.detail || 'Unknown error'));
          }
      } catch (e) {
          console.error(e);
          window.showAdminAlert('Error creating article');
      }
  });
</script>
