---
// ---
---

<div class="filter-card">
  <div class="filter-header">
    <h3 class="filter-title">筛选条件</h3>
    <button id="resetFiltersBtn" class="reset-btn">重置</button>
  </div>

  <!-- 1. Tag 筛选 -->
  <div class="filter-group tag-group">
    <label>标签筛选 (Max 3)</label>
    <div class="tag-input-wrapper" id="tagInputWrapper">
      <div class="selected-tags" id="selectedTags">
        <!-- 选中标签将在这里渲染 -->
        <span class="placeholder">选择标签...</span>
      </div>
      <div class="tag-dropdown hidden" id="tagDropdown">
        <div class="loading-tags" style="padding: 8px; color: #999; font-size: 0.85rem;">Loading tags...</div>
      </div>
    </div>
  </div>

  <!-- 2. 时间筛选 -->
  <div class="filter-group time-group">
    <label>时间排序</label>
    <button id="timeSortBtn" class="sort-btn" data-order="desc">
      <span class="text">最新优先</span>
      <span class="icon">↓</span>
    </button>
  </div>

  <!-- 3. 状态筛选 -->
  <div class="filter-group status-group">
    <label>文章状态</label>
    <div class="custom-select-wrapper" id="statusSelectWrapper">
      <div class="custom-select-trigger" id="statusTrigger">
        <span class="current-text">全部状态</span>
        <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
      </div>
      <div class="custom-options hidden" id="statusOptions">
        <div class="custom-option selected" data-value="all">全部状态</div>
        <div class="custom-option" data-value="public">公开</div>
        <div class="custom-option" data-value="draft">草稿</div>
        <div class="custom-option" data-value="private">私密</div>
      </div>
    </div>
  </div>
</div>

<style>
  .filter-card {
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid #eee;
    /* Fixed height as requested */
    height: 350px;
    overflow-y: visible; /* Allow dropdowns to overflow */
  }

  .filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
  }

  .filter-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  .reset-btn {
    background: none;
    border: none;
    color: #666;
    font-size: 0.85rem;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .reset-btn:hover {
    background: #f5f5f5;
    color: #d32f2f;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    width: 100%;
  }

  .filter-group label {
    font-size: 0.85rem;
    color: #666;
    font-weight: 500;
  }

  /* Tag Input Styles */
  .tag-group {
    position: relative;
    z-index: 20; /* Ensure tag dropdown is above others */
  }

  .tag-input-wrapper {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0 0.5rem; /* Adjusted padding */
    height: 42px; /* Fixed height to match others */
    cursor: pointer;
    background: #fff;
    position: relative;
    transition: border-color 0.2s;
    display: flex;
    align-items: center;
    overflow: visible; /* Changed from hidden to visible so dropdown appears */
  }

  .tag-input-wrapper:hover {
    border-color: #bbb;
  }

  .selected-tags {
    display: flex;
    flex-wrap: nowrap; /* Prevent wrapping to keep height fixed */
    gap: 0.5rem;
    overflow-x: auto; /* Scroll horizontally if too many tags */
    width: 100%;
    align-items: center;
    scrollbar-width: none; /* Hide scrollbar */
  }
  .selected-tags::-webkit-scrollbar { display: none; }

  .placeholder {
    color: #999;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .selected-tags :global(.tag-chip) {
    background: #e0e0e0; /* Darker gray */
    color: #333;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    font-weight: 500;
  }

  .selected-tags :global(.tag-remove) {
    cursor: pointer;
    color: #666;
    font-weight: bold;
    font-size: 1rem;
    line-height: 1;
  }
  .selected-tags :global(.tag-remove:hover) { color: #000; }

  .tag-dropdown {
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 4px;
  }

  .tag-dropdown.hidden {
    display: none;
  }

  .tag-dropdown :global(.tag-option) {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.85rem;
    border-radius: 4px;
    color: #444;
    transition: all 0.2s ease;
    margin-bottom: 2px;
  }

  .tag-dropdown :global(.tag-option:hover) {
    background: #f5f5f7;
    color: #000;
  }

  .tag-dropdown :global(.tag-option.disabled) {
    color: #aaa;
    background: #f9f9f9;
    cursor: not-allowed;
    opacity: 0.7;
  }

  /* Time Sort Styles */
  .sort-btn {
    height: 42px;
    padding: 0 1rem;
    border: 1px solid #ddd;
    background: #fff;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    font-size: 0.9rem;
    transition: all 0.2s;
    color: #333;
  }

  .sort-btn:hover {
    border-color: #bbb;
    background: #fafafa;
  }

  /* Status Select Styles - Custom Implementation */
  .status-group {
    position: relative;
    z-index: 10;
  }

  .status-group .custom-options {
    top: auto;
    bottom: 100%;
    margin-bottom: 6px;
    margin-top: 0;
  }

  .filter-group.active {
    z-index: 100 !important;
  }

  .custom-select-wrapper {
    position: relative;
    width: 100%;
  }

  .custom-select-trigger {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0 1rem;
    height: 42px;
    cursor: pointer;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: border-color 0.2s;
    font-size: 0.9rem;
    color: #333;
  }

  .custom-select-trigger:hover {
    border-color: #bbb;
  }

  .arrow-icon {
    width: 1em;
    height: 1em;
    color: #999;
  }

  .custom-options {
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 4px;
  }

  .custom-options.hidden {
    display: none;
  }

  .custom-option {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.85rem;
    border-radius: 4px;
    color: #444;
    transition: all 0.2s ease;
    margin-bottom: 2px;
  }

  .custom-option:hover {
    background: #f5f5f7;
    color: #000;
  }

  .custom-option.selected {
    background: #f0f0f0;
    color: #000;
    font-weight: 500;
  }
</style>

<script>
  // 简单的交互逻辑
  const tagWrapper = document.getElementById('tagInputWrapper');
  const tagDropdown = document.getElementById('tagDropdown');
  const selectedTagsContainer = document.getElementById('selectedTags');
  const timeSortBtn = document.getElementById('timeSortBtn');
  const resetBtn = document.getElementById('resetFiltersBtn');
  
  // Status Dropdown Logic
  const statusWrapper = document.getElementById('statusSelectWrapper');
  const statusTrigger = document.getElementById('statusTrigger');
  const statusOptions = document.getElementById('statusOptions');
  const currentStatusText = statusTrigger?.querySelector('.current-text');

  // State
  let selectedTags: string[] = [];
  const MAX_TAGS = 3;
  let allTags: string[] = [];

  // Initialize from URL
  const urlParams = new URLSearchParams(window.location.search);
  selectedTags = urlParams.getAll('tags');
  renderTags();

  // Initialize Sort Button State
  const currentSort = urlParams.get('sort') || 'desc';
  if (timeSortBtn) {
    timeSortBtn.dataset.order = currentSort;
    const textSpan = timeSortBtn.querySelector('.text');
    const iconSpan = timeSortBtn.querySelector('.icon');
    
    if (textSpan && iconSpan) {
      textSpan.textContent = currentSort === 'desc' ? '最新优先' : '最早优先';
      iconSpan.textContent = currentSort === 'desc' ? '↓' : '↑';
    }
  }

  // Initialize Status from URL
  const currentStatus = urlParams.get('status') || 'all';
  if (statusTrigger && statusOptions) {
      const selectedOption = statusOptions.querySelector(`.custom-option[data-value="${currentStatus}"]`);
      if (selectedOption) {
          // Update text
          const text = selectedOption.textContent;
          if (currentStatusText && text) currentStatusText.textContent = text;
          
          // Update selected class
          statusOptions.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
          selectedOption.classList.add('selected');
      }
  }

  // Fetch tags independently
  async function fetchTags() {
    try {
      const response = await fetch('/api/admin/articles/tags');
      if (response.ok) {
        const data = await response.json();
        allTags = data.tags || [];
        renderDropdownOptions();
      }
    } catch (e) {
      console.error('Failed to fetch tags', e);
    }
  }

  fetchTags();
  
  // Listen for data changes (e.g. delete) to refresh tags
  window.addEventListener('article-data-changed', fetchTags);

  function renderDropdownOptions() {
    if (!tagDropdown) return;
    if (allTags.length === 0) {
      tagDropdown.innerHTML = '<div style="padding: 8px; color: #999;">No tags found</div>';
      return;
    }
    tagDropdown.innerHTML = allTags.map(tag => 
      `<div class="tag-option" data-tag="${tag}">${tag}</div>`
    ).join('');
    updateDropdownState();
  }

  function updateDropdownState() {
    document.querySelectorAll('.tag-option').forEach(opt => {
      const el = opt as HTMLElement;
      if (selectedTags.includes(el.dataset.tag || '')) {
        el.classList.add('disabled');
      } else {
        el.classList.remove('disabled');
      }
    });
  }

  function updateUrl() {
    const url = new URL(window.location.href);
    url.searchParams.delete('tags');
    selectedTags.forEach(tag => url.searchParams.append('tags', tag));
    url.searchParams.set('page', '1'); // Reset to first page
    
    window.history.pushState({}, '', url.toString());
    window.dispatchEvent(new CustomEvent('article-filter-change'));
  }

  // Initialize
  // fetchTags(); // Called above

  // Helper to toggle active class
  function toggleGroupActive(groupClass: string, active: boolean) {
    const group = document.querySelector(`.${groupClass}`);
    if (active) group?.classList.add('active');
    else group?.classList.remove('active');
  }

  statusTrigger?.addEventListener('click', (e) => {
    e.stopPropagation();
    const isHidden = statusOptions?.classList.contains('hidden');
    
    // Close others
    tagDropdown?.classList.add('hidden');
    toggleGroupActive('tag-group', false);
    
    if (isHidden) {
        statusOptions?.classList.remove('hidden');
        toggleGroupActive('status-group', true);
    } else {
        statusOptions?.classList.add('hidden');
        toggleGroupActive('status-group', false);
    }
  });

  statusOptions?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.classList.contains('custom-option')) {
      // Update UI
      const value = target.dataset.value;
      const text = target.textContent;
      
      if (currentStatusText && text) currentStatusText.textContent = text;
      
      // Update selected class
      statusOptions.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
      target.classList.add('selected');
      
      // Close dropdown
      statusOptions.classList.add('hidden');
      toggleGroupActive('status-group', false);
      
      // Update URL
      const url = new URL(window.location.href);
      if (value && value !== 'all') {
          url.searchParams.set('status', value);
      } else {
          url.searchParams.delete('status');
      }
      url.searchParams.set('page', '1');
      
      window.history.pushState({}, '', url.toString());
      window.dispatchEvent(new CustomEvent('article-filter-change'));
    }
  });
  
  // Tag Dropdown Toggle
  tagWrapper?.addEventListener('click', (e) => {
    // 防止点击移除按钮时触发
    if ((e.target as HTMLElement).classList.contains('tag-remove')) return;
    
    const isHidden = tagDropdown?.classList.contains('hidden');
    
    // Close others
    statusOptions?.classList.add('hidden');
    toggleGroupActive('status-group', false);
    
    if (isHidden) {
        tagDropdown?.classList.remove('hidden');
        toggleGroupActive('tag-group', true);
    } else {
        tagDropdown?.classList.add('hidden');
        toggleGroupActive('tag-group', false);
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!tagWrapper?.contains(e.target as Node)) {
      tagDropdown?.classList.add('hidden');
      toggleGroupActive('tag-group', false);
    }
    if (!statusWrapper?.contains(e.target as Node)) {
      statusOptions?.classList.add('hidden');
      toggleGroupActive('status-group', false);
    }
  });

  // Handle Tag Selection
  tagDropdown?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.classList.contains('tag-option')) {
      const tag = target.dataset.tag;
      if (tag && !selectedTags.includes(tag)) {
        if (selectedTags.length < MAX_TAGS) {
          addTag(tag || '');
        } else {
          alert('最多只能选择3个标签');
        }
      }
    }
  });

  function addTag(tag: string) {
    selectedTags.push(tag);
    renderTags();
    updateDropdownState();
    updateUrl();
  }

  function removeTag(tag: string) {
    selectedTags = selectedTags.filter(t => t !== tag);
    renderTags();
    updateDropdownState();
    updateUrl();
  }

  function renderTags() {
    if (!selectedTagsContainer) return;
    
    if (selectedTags.length === 0) {
      selectedTagsContainer.innerHTML = '<span class="placeholder">选择标签...</span>';
    } else {
      selectedTagsContainer.innerHTML = selectedTags.map(tag => `
        <span class="tag-chip">
          ${tag}
          <span class="tag-remove" data-tag="${tag}">×</span>
        </span>`).join('');
      
      // Re-attach remove listeners
      document.querySelectorAll('.tag-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const tagToRemove = (e.target as HTMLElement).dataset.tag;
          if (tagToRemove) removeTag(tagToRemove);
        });
      });
    }
  }

  // Time Sort Toggle
  timeSortBtn?.addEventListener('click', () => {
    const currentOrder = timeSortBtn.dataset.order;
    const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
    
    const url = new URL(window.location.href);
    url.searchParams.set('sort', newOrder);
    url.searchParams.set('page', '1');
    
    // Update UI immediately
    timeSortBtn.dataset.order = newOrder;
    const textSpan = timeSortBtn.querySelector('.text');
    const iconSpan = timeSortBtn.querySelector('.icon');
    if (textSpan && iconSpan) {
      textSpan.textContent = newOrder === 'desc' ? '最新优先' : '最早优先';
      iconSpan.textContent = newOrder === 'desc' ? '↓' : '↑';
    }

    window.history.pushState({}, '', url.toString());
    window.dispatchEvent(new CustomEvent('article-filter-change'));
  });

  // Reset Button Logic
  resetBtn?.addEventListener('click', () => {
    // 1. Reset Tags
    selectedTags = [];
    renderTags();
    updateDropdownState();

    // 2. Reset Sort
    if (timeSortBtn) {
      timeSortBtn.dataset.order = 'desc';
      const textSpan = timeSortBtn.querySelector('.text');
      const iconSpan = timeSortBtn.querySelector('.icon');
      if (textSpan && iconSpan) {
        textSpan.textContent = '最新优先';
        iconSpan.textContent = '↓';
      }
    }

    // 3. Reset Status
    if (statusTrigger && statusOptions && currentStatusText) {
        currentStatusText.textContent = '全部状态';
        statusOptions.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
        const allOption = statusOptions.querySelector('[data-value="all"]');
        if (allOption) allOption.classList.add('selected');
    }

    // 4. Update URL (Keep category, remove others)
    const url = new URL(window.location.href);
    url.searchParams.delete('tags');
    url.searchParams.delete('sort');
    url.searchParams.delete('status');
    url.searchParams.set('page', '1');
    
    window.history.pushState({}, '', url.toString());
    window.dispatchEvent(new CustomEvent('article-filter-change'));
  });
</script>
