---
interface Article {
  id: string;
  title: string;
  category: string;
  tags: string[];
  status: 'published' | 'draft' | 'archived';
  createdAt: string;
}

interface Props {
  articles?: Article[];
}

let { articles = [] } = Astro.props;
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const category = Astro.url.searchParams.get('category');
const tags = Astro.url.searchParams.getAll('tags');
const sort = Astro.url.searchParams.get('sort') || 'desc';
const status = Astro.url.searchParams.get('status');
const pageSize = 10;
const skip = (page - 1) * pageSize;
let hasNextPage = false;

// 如果没有通过 Props 传入数据，则尝试从 API 获取
if (articles.length === 0) {
  try {
    // 多获取一条以判断是否有下一页
    const fetchLimit = pageSize + 1;
    const params = new URLSearchParams();
    params.append('skip', skip.toString());
    params.append('limit', fetchLimit.toString());
    params.append('sort', sort);
    if (status && status !== 'all') params.append('status', status);
    if (category) params.append('category', category);
    tags.forEach(tag => params.append('tags', tag));

    const response = await fetch(`http://127.0.0.1:8000/api/admin/articles?${params.toString()}`);
    if (response.ok) {
      const data = await response.json();
      const mappedArticles = data.map((item: any) => ({
        id: item.id,
        title: item.title,
        category: typeof item.category === 'object' ? item.folder?.name : (item.folder || 'Uncategorized'),
        tags: Array.isArray(item.tags) ? item.tags.map((t: any) => typeof t === 'object' ? t.name : t) : [],
        status: item.status || (item.is_published ? 'published' : 'draft'),
        createdAt: item.date || (item.created_at ? new Date(item.created_at).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]),
      }));

      if (mappedArticles.length > pageSize) {
        hasNextPage = true;
        articles = mappedArticles.slice(0, pageSize);
      } else {
        hasNextPage = false;
        articles = mappedArticles;
      }
    }
  } catch (e) {
    console.error("Failed to fetch articles from API", e);
  }
} else {
  hasNextPage = articles.length === pageSize;
}

const getPageUrl = (p: number) => {
  const params = new URLSearchParams(Astro.url.searchParams);
  params.set('page', p.toString());
  return `?${params.toString()}`;
};
---

<div class="page-wrapper">
  <h2 class="section-title">文章列表</h2>
  
  <div class="article-list-container">
    <table class="article-table">
      <thead>
        <tr>
          <th class="col-title">Title</th>
          <th class="col-category">Category</th>
          <th class="col-tags">Tags</th>
          <th class="col-status">Status</th>
          <th class="col-date">Date</th>
          <th class="col-actions text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        {articles.length > 0 ? (
          articles.map((article) => (
          <tr>
            <td class="col-title">
              <span class="title-text">{article.title}</span>
            </td>
            <td class="col-category">
              <span class="category-badge">{article.category}</span>
            </td>
            <td class="col-tags">
              <div class="tags-wrapper">
                {article.tags.map(tag => <span class="tag-box">{tag}</span>)}
              </div>
            </td>
            <td class="col-status">
              <div class="select-wrapper">
                <select class={`status-select status-${article.status}`} value={article.status}>
                  <option value="published">Published</option>
                  <option value="draft">Draft</option>
                  <option value="archived">Archived</option>
                </select>
              </div>
            </td>
            <td class="col-date">
              <span class="date-text">{article.createdAt}</span>
            </td>
            <td class="col-actions">
              <button class="btn-icon edit" aria-label="Edit">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
              </button>
              <button class="btn-icon delete" aria-label="Delete">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
              </button>
            </td>
          </tr>
        ))
        ) : (
          <tr>
            <td colspan="6" class="no-data">
              <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="empty-icon"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <p>没有找到符合条件的文章</p>
              </div>
            </td>
          </tr>
        )}
      </tbody>
    </table>

    <div class="pagination-bar">
      <div class="pagination-controls">
        <a href={page > 1 ? getPageUrl(page - 1) : '#'} class={`btn-page ${page <= 1 ? 'disabled' : ''}`} aria-label="Previous Page">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </a>
        
        <div class="page-input-container">
          <input type="number" id="page-input" class="page-input" min="1" value={page} />
        </div>

        <a href={hasNextPage ? getPageUrl(page + 1) : '#'} class={`btn-page ${!hasNextPage ? 'disabled' : ''}`} aria-label="Next Page">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  const pageInput = document.getElementById('page-input') as HTMLInputElement;
  
  if (pageInput) {
    pageInput.addEventListener('change', () => {
      let page = parseInt(pageInput.value);
      if (isNaN(page) || page < 1) page = 1;
      
      const url = new URL(window.location.href);
      url.searchParams.set('page', page.toString());
      window.location.href = url.toString();
    });

    pageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        pageInput.blur(); // Trigger change event
      }
    });
  }
</script>

<style>
  :root {
    --bg-surface: #ffffff;
    --bg-hover: #f9fafb;
    --border-color: #e5e7eb;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --primary-color: #4f46e5;
    --danger-color: #ef4444;
    
    --status-published-bg: #d1fae5;
    --status-published-text: #065f46;
    --status-draft-bg: #fef3c7;
    --status-draft-text: #92400e;
    --status-archived-bg: #f3f4f6;
    --status-archived-text: #374151;

    --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    --font-mono: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
  }

  .page-wrapper {
    width: 100%;
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.25rem;
    font-family: var(--font-main);
    letter-spacing: -0.025em;
  }

  .article-list-container {
    background: var(--bg-surface);
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    overflow: hidden; /* Ensures child elements don't break border-radius */
    border: 1px solid var(--border-color);
    width: 100%;
    font-family: var(--font-main);
    display: flex;
    flex-direction: column;
  }

  .article-table {
    width: 100%;
    border-collapse: collapse;
    font-family: var(--font-main);
    font-size: 0.875rem;
    table-layout: fixed; /* 固定列宽 */
    flex: 1;
  }

  th {
    background-color: var(--bg-hover);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    padding: 1rem 1.5rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    border-right: 1px solid var(--border-color); /* 竖线分隔 */
  }
  
  th:last-child {
    border-right: none;
  }

  td {
    padding: 1rem 1.5rem;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
    vertical-align: middle;
    border-right: 1px solid var(--border-color); /* 竖线分隔 */
  }

  td:last-child {
    border-right: none;
  }

  tr:last-child td {
    border-bottom: none;
  }

  tr:hover td {
    background-color: var(--bg-hover);
  }

  /* Column Specifics */
  .col-title {
    width: 20%;
  }

  .title-text {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
  }

  .col-category {
    width: 10%;
  }

  .category-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background-color: #e0e7ff;
    color: #3730a3;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .col-tags {
    width: 20%;
  }

  .tags-wrapper {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .tag-box {
    display: inline-block;
    padding: 2px 6px;
    background-color: #f1f5f9;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    color: #475569;
    font-size: 0.75rem;
    font-weight: 500;
    line-height: 1.2;
  }

  .col-status {
    width: 12%;
  }

  .select-wrapper {
    position: relative;
    width: 100%;
  }

  .status-select {
    appearance: none;
    width: 100%;
    padding: 0.35rem 1.75rem 0.35rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.25rem center;
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .status-select:hover {
    filter: brightness(0.95);
  }

  .status-select:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
  }

  .col-date {
    width: 8%;
  }

  .date-text {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-family: var(--font-mono);
  }

  .col-actions {
    text-align: middle;
    white-space: nowrap;
    width: 5%;
  }

  .btn-icon {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    color: var(--text-secondary);
    transition: all 0.2s;
    margin-left: 0.25rem;
  }

  .btn-icon:hover {
    background-color: #e5e7eb;
  }

  .btn-icon.edit:hover {
    color: var(--primary-color);
    background-color: #e0e7ff;
  }

  .btn-icon.delete:hover {
    color: var(--danger-color);
    background-color: #fee2e2;
  }

  /* Pagination */
  .pagination-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    background-color: var(--bg-surface);
  }

  .pagination-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .btn-page {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    padding: 0;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--bg-surface);
    color: #666;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s;
  }

  .btn-page:hover:not(.disabled) {
    background-color: #f5f5f5;
    color: #000;
    border-color: #ddd;
  }

  .btn-page.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
    background-color: var(--bg-surface);
  }

  .page-input-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .page-input {
    width: 40px;
    height: 32px;
    text-align: center;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-family: inherit;
    font-size: 0.9rem;
    color: var(--text-primary);
    outline: none;
    transition: border-color 0.2s;
    -moz-appearance: textfield;
  }
  .page-input::-webkit-outer-spin-button,
  .page-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .page-input:focus {
    border-color: var(--text-primary);
  }

  .no-data {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary);
  }
  
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }
  
  .empty-icon {
    color: #d1d5db;
  }
</style>
