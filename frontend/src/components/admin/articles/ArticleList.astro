---
---
<div class="article-list-card">
    <div class="card-header">
        <span>Article List</span>
        <span class="count" id="article-count">0 articles</span>
    </div>
    <div class="table-container">
        <table class="article-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Slug</th>
                    <th>Category</th>
                    <th>Tags</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="article-table-body">
                <!-- Rows will be populated by JS -->
                <tr><td colspan="7" class="loading-text">Loading...</td></tr>
            </tbody>
        </table>
    </div>
    <div class="pagination" id="pagination">
        <!-- Pagination buttons -->
    </div>
</div>

<script>
    interface Article {
        id: string;
        title: string;
        slug?: string;
        url?: string;
        category?: string;
        folder?: string;
        tags?: string[];
        status?: string;
        date?: string;
    }

    let allArticles: Article[] = [];
    let filteredArticles: Article[] = [];
    let currentPage = 1;
    const pageSize = 10;
    let currentFilters = {
        title: '',
        category: '',
        tags: [],
        status: ''
    };

    async function fetchArticles() {
        const tbody = document.getElementById('article-table-body');
        if(tbody) tbody.innerHTML = '<tr><td colspan="7" class="loading-text">Loading...</td></tr>';

        try {
            const res = await fetch('/api/admin/articles'); // Ensure this endpoint exists
            if (!res.ok) throw new Error('Failed to fetch');
            allArticles = await res.json();

            // Derive categories (folders) from articles
            const folderSet = new Set<string>();
            allArticles.forEach(article => {
                const cat = article.folder || article.category;
                if (cat) {
                    const parts = cat.split('/');
                    let current = '';
                    parts.forEach(p => {
                        if(!p) return;
                        current = current ? `${current}/${p}` : p;
                        folderSet.add(current);
                    });
                }
            });
            const categories = Array.from(folderSet).map(path => ({ path }));

            // Derive tags from articles
            const tagCounts = allArticles.flatMap(article => article.tags || []).reduce((acc, tag) => {
                acc[tag] = (acc[tag] || 0) + 1;
                return acc;
            }, {} as Record<string, number>);
            const tags = Object.keys(tagCounts).sort();

            // Broadcast data to other components
            document.dispatchEvent(new CustomEvent('articles-data-loaded', { 
                detail: { categories, tags } 
            }));

            applyFilters();
        } catch (error) {
            console.error(error);
            // Mock data for demonstration if API fails
            // allArticles = []; 
            if(tbody) tbody.innerHTML = '<tr><td colspan="7" class="error-text">Failed to load articles.</td></tr>';
        }
    }

    function applyFilters() {
        filteredArticles = allArticles.filter(article => {
            const matchTitle = !currentFilters.title || article.title.toLowerCase().includes(currentFilters.title.toLowerCase());
            const cat = article.folder || article.category;
            const matchCategory = !currentFilters.category || cat === currentFilters.category || cat?.startsWith(currentFilters.category + '/');
            const matchStatus = !currentFilters.status || (article.status || 'published') === currentFilters.status;
            // Fix: Handle undefined tags safely
            const matchTags = !currentFilters.tags.length || currentFilters.tags.every(tag => (article.tags || []).includes(tag));
            return matchTitle && matchCategory && matchStatus && matchTags;
        });
        currentPage = 1;
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('article-table-body');
        const countSpan = document.getElementById('article-count');
        const pagination = document.getElementById('pagination');
        
        if (!tbody) return;

        if (countSpan) countSpan.textContent = `${filteredArticles.length} articles`;

        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = filteredArticles.slice(start, end);

        if (pageData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-text">No articles found</td></tr>';
            if(pagination) pagination.innerHTML = '';
            return;
        }

        tbody.innerHTML = pageData.map(article => `
            <tr>
                <td><div class="title" title="${article.title}">${article.title}</div></td>
                <td><div class="slug">${article.url || article.slug || ''}</div></td>
                <td><span class="category">${article.folder || article.category || 'Uncategorized'}</span></td>
                <td>
                    <div class="tags">
                        ${(article.tags || []).slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('')}
                        ${(article.tags || []).length > 3 ? `<span class="more-tags">+${(article.tags || []).length - 3}</span>` : ''}
                    </div>
                </td>
                <td>
                    <select class="status-select" data-id="${article.id}" onchange="updateStatus('${article.id}', this.value)">
                        <option value="draft" ${article.status === 'draft' ? 'selected' : ''}>Draft</option>
                        <option value="published" ${(!article.status || article.status === 'published') ? 'selected' : ''}>Published</option>
                        <option value="recycled" ${article.status === 'recycled' ? 'selected' : ''}>Recycled</option>
                    </select>
                </td>
                <td>${article.date ? new Date(article.date).toLocaleDateString() : ''}</td>
                <td>
                    <div class="actions">
                        <button class="btn-icon edit" onclick="editArticle('${article.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-icon delete" onclick="deleteArticle('${article.id}')"><i class="fas fa-trash"></i></button>
                        ${(!article.status || article.status === 'published') ? `<a href="/posts/${article.url}" target="_blank" class="btn-icon view"><i class="fas fa-external-link-alt"></i></a>` : ''}
                    </div>
                </td>
            </tr>
        `).join('');

        renderPagination();
    }

    function renderPagination() {
        const pagination = document.getElementById('pagination');
        if (!pagination) return;

        const totalPages = Math.ceil(filteredArticles.length / pageSize);
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let html = `<button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">&lt;</button>`;
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += `<span>...</span>`;
            }
        }
        html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">&gt;</button>`;
        pagination.innerHTML = html;
    }

    // Expose functions to global scope for inline event handlers
    declare global {
        interface Window {
            changePage: (page: number) => void;
            updateStatus: (id: string, status: string) => Promise<void>;
            deleteArticle: (id: string) => Promise<void>;
            editArticle: (id: string) => void;
        }
    }

    window.changePage = (page) => {
        currentPage = page;
        renderTable();
    };

    window.updateStatus = async (id, status) => {
        try {
            await fetch(`/api/admin/articles/${id}/status`, { 
                method: 'PUT', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status }) 
            });
            console.log(`Update status for ${id} to ${status}`);
            // Optimistic update
            const article = allArticles.find(a => a.id === id);
            if (article) article.status = status;
        } catch (e) {
            console.error(e);
            alert('Failed to update status');
        }
    };

    window.deleteArticle = async (id) => {
        if (!confirm('Are you sure you want to delete this article?')) return;
        try {
            await fetch(`/api/admin/articles/${id}`, { method: 'DELETE' });
            console.log(`Delete article ${id}`);
            // Fix: Added missing parenthesis before 'a'
            allArticles = allArticles.filter(a => a.id !== id);
            applyFilters();
        } catch (e) {
            console.error(e);
            alert('Failed to delete article');
        }
    };

    window.editArticle = (id) => {
        console.log('Edit', id);
        // Dispatch event to open edit dialog
        // document.dispatchEvent(new CustomEvent('open-edit-modal', { detail: { id } }));
    };

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        fetchArticles();

        document.addEventListener('refresh-articles', fetchArticles);
        document.addEventListener('article-uploaded', fetchArticles);

        document.addEventListener('filter-changed', (e) => {
            const detail = (e as CustomEvent).detail;
            currentFilters = { ...currentFilters, ...detail };
            applyFilters();
        });
    });
</script>

<style>
    .article-list-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px 0 rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .card-header {
        padding: 16px 20px;
        border-bottom: 1px solid #ebeef5;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
    }

    .count {
        color: #909399;
        font-size: 14px;
        font-weight: normal;
    }

    .table-container {
        overflow-x: auto;
    }

    .article-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .article-table th {
        background: #fafafa;
        color: #606266;
        font-weight: 600;
        text-align: left;
        padding: 12px 16px;
    }

    .article-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #ebeef5;
        color: #606266;
    }

    .article-table tr:hover {
        background-color: #f5f7fa;
    }

    .title {
        font-weight: 500;
        color: #303133;
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .slug {
        font-family: monospace;
        color: #909399;
        font-size: 12px;
    }

    .tags {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }

    .tag {
        background: #f4f4f5;
        color: #909399;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
    }

    .status-select {
        padding: 4px;
        border-radius: 4px;
        border: 1px solid #dcdfe6;
        font-size: 12px;
    }

    .actions {
        display: flex;
        gap: 8px;
    }

    .btn-icon {
        border: none;
        background: none;
        cursor: pointer;
        padding: 4px;
        color: #606266;
        transition: color 0.2s;
    }

    .btn-icon:hover { color: #000000; }
    .btn-icon.delete:hover { color: #f56c6c; }

    .pagination {
        padding: 16px;
        display: flex;
        justify-content: center;
        gap: 4px;
    }

    .pagination button {
        padding: 4px 12px;
        border: 1px solid #dcdfe6;
        background: white;
        border-radius: 4px;
        cursor: pointer;
    }

    .pagination button.active {
        background: #000000;
        color: white;
        border-color: #000000;
    }

    .pagination button:disabled {
        background: #f5f7fa;
        color: #c0c4cc;
        cursor: not-allowed;
    }
</style>
