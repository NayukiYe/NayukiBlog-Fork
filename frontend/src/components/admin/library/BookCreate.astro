---
// BookCreate.astro
import AlertModal from '../AlertModal.astro';
---

<div class="create-card">
  <div class="card-header">
    <div style="display:flex; align-items:center; gap:10px;">
        <h3 class="card-title" id="bookCardTitle">New Book</h3>
        <button type="button" id="resetBookBtn" class="btn-reset hidden" style="background:none;border:none;cursor:pointer;color:#666;font-size:0.8rem;"><i class="fas fa-times"></i> Cancel</button>
    </div>
    <button type="submit" form="create-book-form" class="btn-submit-header" id="bookSubmitBtn">
      <i class="fas fa-plus"></i> Add
    </button>
  </div>

  <form id="create-book-form" class="create-form" novalidate>
    <input type="hidden" name="book_id" id="bookIdInput">
    <!-- Title -->
    <div class="form-row">
      <div class="form-group title-group">
        <label>Title</label>
        <input type="text" name="title" class="form-input" placeholder="Book Title">
      </div>
    </div>

    <!-- Rating & Status -->
    <div class="form-row">
      <div class="form-group rating-group">
        <label>Rating (1-5)</label>
        <input type="number" name="rating" min="1" max="5" class="form-input" placeholder="5">
      </div>

      <div class="form-group status-group">
        <label>Status</label>
        <div class="custom-select-wrapper" id="createStatusWrapper">
          <div class="custom-select-trigger" id="createStatusTrigger">
            <span class="current-text">Published</span>
            <input type="hidden" name="status" value="published">
            <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
          <div class="custom-options hidden" id="createStatusOptions">
            <div class="custom-option selected" data-value="published">Published</div>
            <div class="custom-option" data-value="draft">Draft</div>
            <div class="custom-option" data-value="archived">Archived</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tags -->
    <div class="form-row">
      <div class="form-group tags-group">
        <label>Tags</label>
        <div class="tags-input-container" id="bookTagsContainer">
          <div class="create-selected-tags" id="bookSelectedTags"></div>
          <div class="create-tag-wrapper">
            <input type="text" id="bookTagInput" class="create-tag-input" placeholder="Add tag..." autocomplete="off">
            <button type="button" class="create-tag-confirm-btn" id="bookConfirmTagBtn">
              <i class="fas fa-check"></i>
            </button>
            <div class="create-tags-dropdown hidden" id="bookTagsDropdown"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cover URL -->
    <div class="form-row">
      <div class="form-group cover-group">
        <label>Cover URL</label>
        <input type="url" name="cover" class="form-input" placeholder="https://example.com/cover.jpg">
      </div>
    </div>

    <!-- Book URL -->
    <div class="form-row">
      <div class="form-group url-group">
        <label>Book URL</label>
        <input type="url" name="url" class="form-input" placeholder="https://example.com/book-link">
      </div>
    </div>
  </form>
</div>

<AlertModal />

<style>
  .create-card {
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 1px solid #eee;
    height: 470px; /* Fixed height to match filter */
    display: flex;
    flex-direction: column;
    gap: 1rem;
    box-sizing: border-box;
  }

  .card-header {
    padding-bottom: 0.8rem;
    border-bottom: 1px solid #eee;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #333;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .create-form {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    flex: 1;
    overflow-y: auto;
  }

  .form-row {
    display: flex;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    flex: 1;
  }

  .title-group { flex: 2; }
  .status-group { flex: 1; }

  label {
    font-size: 0.8rem;
    color: #666;
    font-weight: 500;
  }

  .form-input {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.85rem;
    width: 100%;
    box-sizing: border-box;
    height: 36px;
  }

  .form-input:focus {
    border-color: #000;
    outline: none;
  }

  /* Custom Select */
  .custom-select-wrapper {
    position: relative;
    width: 100%;
  }

  .custom-select-trigger {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0 0.6rem;
    cursor: pointer;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 36px;
    font-size: 0.85rem;
    color: #333;
    box-sizing: border-box;
  }

  .custom-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 4px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 4px;
  }

  .custom-options.hidden { display: none; }

  .custom-option {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.85rem;
    color: #444;
  }

  .custom-option:hover { background: #f5f5f7; }
  .custom-option.selected { background: #f0f7ff; color: #0066cc; }



  .btn-submit-header {
    background: #000;
    color: white;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    transition: background 0.2s;
  }

  .btn-submit-header:hover {
    background: #333;
  }

  /* Tags Input Styles */
  :global(.tags-input-container) {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0.4rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    background: #fff;
    min-height: 36px;
    box-sizing: border-box;
    width: 100%;
  }

  :global(.tags-input-container:focus-within) {
    border-color: #000;
  }

  :global(.create-selected-tags) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  :global(.create-tag) {
    background: #f0f0f0;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    color: #333;
  }

  :global(.create-tag i) {
    cursor: pointer;
    font-size: 0.75rem;
    color: #999;
    transition: color 0.2s;
  }

  :global(.create-tag i:hover) {
    color: #d32f2f;
  }

  :global(.create-tag-input) {
    border: none;
    outline: none;
    flex: 1;
    min-width: 60px;
    font-size: 0.85rem;
    padding: 0.2rem;
    background: transparent;
  }

  :global(.create-tag-wrapper) {
    position: relative;
    display: flex;
    align-items: center;
    flex: 1;
    min-width: 100px;
  }

  :global(.create-tag-confirm-btn) {
    background: none;
    border: none;
    color: #4caf50;
    cursor: pointer;
    padding: 0 8px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    transition: color 0.2s;
  }
  
  :global(.create-tag-confirm-btn:hover) {
    color: #388e3c;
  }

  :global(.create-tags-dropdown) {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background: white;
    border: 1px solid #eee;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    max-height: 150px;
    overflow-y: auto;
    z-index: 100;
    margin-top: 4px;
  }

  :global(.create-tags-dropdown.hidden) {
    display: none;
  }

  :global(.create-tag-suggestion) {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.85rem;
    color: #333;
  }

  :global(.create-tag-suggestion:hover) {
    background: #f5f5f5;
  }
</style>

<script>
  declare global {
    interface Window {
      showAdminAlert: (message: string, type?: 'error' | 'success' | 'info') => void;
    }
  }

  // Status Dropdown
  const statusWrapper = document.getElementById('createStatusWrapper');
  const statusTrigger = document.getElementById('createStatusTrigger');
  const statusOptions = document.getElementById('createStatusOptions');
  const statusInput = statusWrapper?.querySelector('input');
  const statusText = statusWrapper?.querySelector('.current-text');

  statusTrigger?.addEventListener('click', (e) => {
    e.stopPropagation();
    statusOptions?.classList.toggle('hidden');
  });

  statusOptions?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.classList.contains('custom-option')) {
      const value = target.getAttribute('data-value');
      const text = target.textContent;
      
      statusOptions.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
      target.classList.add('selected');
      
      if (statusText) statusText.textContent = text;
      if (statusInput) statusInput.value = value || '';
      
      statusOptions.classList.add('hidden');
    }
  });

  document.addEventListener('click', (e) => {
    if (!statusWrapper?.contains(e.target as Node)) {
      statusOptions?.classList.add('hidden');
    }
  });

  // File Input
  const fileInput = document.getElementById('book-cover-input') as HTMLInputElement;
  const fileNameDisplay = document.getElementById('cover-filename');
  
  fileInput?.addEventListener('change', () => {
    if (fileInput.files && fileInput.files.length > 0) {
      if (fileNameDisplay) fileNameDisplay.textContent = fileInput.files[0].name;
    } else {
      if (fileNameDisplay) fileNameDisplay.textContent = 'Click to upload cover';
    }
  });

  // Tags Logic
  const bookTagInput = document.getElementById('bookTagInput') as HTMLInputElement;
  const bookConfirmTagBtn = document.getElementById('bookConfirmTagBtn');
  const bookTagsDropdown = document.getElementById('bookTagsDropdown');
  const bookSelectedTags = document.getElementById('bookSelectedTags');
  let bookTags: string[] = [];
  let availableBookTags: string[] = [];

  async function fetchBookTags() {
    try {
      const res = await fetch('http://127.0.0.1:8000/api/admin/books/tags');
      if (res.ok) {
        const data = await res.json();
        availableBookTags = data.tags || [];
      }
    } catch (e) {
      console.error('Failed to fetch book tags', e);
    }
  }
  fetchBookTags();

  function renderBookTags() {
    if (!bookSelectedTags) return;
    bookSelectedTags.innerHTML = bookTags.map(tag => `
      <span class="create-tag">
        ${tag}
        <i class="fas fa-times" data-tag="${tag}"></i>
      </span>
    `).join('');
    
    bookSelectedTags.querySelectorAll('.create-tag i').forEach(icon => {
        icon.addEventListener('click', (e) => {
            const tagToRemove = (e.target as HTMLElement).getAttribute('data-tag');
            if (tagToRemove) removeBookTag(tagToRemove);
        });
    });
  }

  function removeBookTag(tag: string) {
    bookTags = bookTags.filter(t => t !== tag);
    renderBookTags();
    filterBookTagsDropdown(bookTagInput.value);
  }

  function addBookTag(val: string) {
    val = val.trim();
    if (val && !bookTags.includes(val)) {
      bookTags.push(val);
      if (bookTagInput) bookTagInput.value = '';
      renderBookTags();
      filterBookTagsDropdown('');
    }
  }

  function filterBookTagsDropdown(query: string) {
    if (!bookTagsDropdown) return;
    
    const filtered = availableBookTags.filter(t => 
      t.toLowerCase().includes(query.toLowerCase()) && !bookTags.includes(t)
    );

    if (filtered.length > 0) {
      bookTagsDropdown.innerHTML = filtered.map(t => `
        <div class="create-tag-suggestion" data-value="${t}">${t}</div>
      `).join('');
      bookTagsDropdown.classList.remove('hidden');
    } else {
      bookTagsDropdown.classList.add('hidden');
    }
  }

  bookTagInput?.addEventListener('focus', () => {
    filterBookTagsDropdown(bookTagInput.value);
  });

  bookTagInput?.addEventListener('input', () => {
    filterBookTagsDropdown(bookTagInput.value);
  });

  bookTagInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addBookTag(bookTagInput.value);
    }
  });

  bookConfirmTagBtn?.addEventListener('click', () => {
    addBookTag(bookTagInput.value);
  });

  bookTagsDropdown?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.classList.contains('create-tag-suggestion')) {
      const val = target.getAttribute('data-value');
      if (val) {
          addBookTag(val);
          bookTagInput?.focus();
      }
    }
  });

  document.addEventListener('click', (e) => {
    if (!bookTagInput?.contains(e.target as Node) && !bookTagsDropdown?.contains(e.target as Node)) {
      bookTagsDropdown?.classList.add('hidden');
    }
  });

  // Form Submit
  const form = document.getElementById('create-book-form') as HTMLFormElement;
  const bookIdInput = document.getElementById('bookIdInput') as HTMLInputElement;
  const bookCardTitle = document.getElementById('bookCardTitle');
  const bookSubmitBtn = document.getElementById('bookSubmitBtn');
  const resetBookBtn = document.getElementById('resetBookBtn');

  // Reset function
  function resetBookForm() {
      form.reset();
      if (bookIdInput) bookIdInput.value = '';
      if (bookCardTitle) bookCardTitle.textContent = 'New Book';
      if (bookSubmitBtn) {
          bookSubmitBtn.innerHTML = '<i class="fas fa-plus"></i> Add';
      }
      if (resetBookBtn) resetBookBtn.classList.add('hidden');
      
      // Reset tags
      bookTags = [];
      renderBookTags();
      
      // Reset status
      if (statusText) statusText.textContent = 'Published';
      if (statusInput) statusInput.value = 'published';
      statusOptions?.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
      statusOptions?.querySelector('[data-value="published"]')?.classList.add('selected');
  }

  resetBookBtn?.addEventListener('click', resetBookForm);

  // Listen for edit
  window.addEventListener('edit-book', (e: any) => {
      const book = e.detail;
      if (!book) return;
      
      resetBookForm(); // Clear first
      
      if (bookIdInput) bookIdInput.value = book.id;
      if (bookCardTitle) bookCardTitle.textContent = 'Edit Book';
      if (bookSubmitBtn) {
          bookSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Save';
      }
      if (resetBookBtn) resetBookBtn.classList.remove('hidden');

      // Fill fields
      const titleInput = form.querySelector('input[name="title"]') as HTMLInputElement;
      const ratingInput = form.querySelector('input[name="rating"]') as HTMLInputElement;
      const coverInput = form.querySelector('input[name="cover"]') as HTMLInputElement;
      const urlInput = form.querySelector('input[name="url"]') as HTMLInputElement;
      
      if (titleInput) titleInput.value = book.title;
      if (ratingInput) ratingInput.value = book.rating || '';
      if (coverInput) coverInput.value = book.cover || '';
      if (urlInput) urlInput.value = book.url || '';
      
      // Status
      const status = book.status?.toLowerCase() || 'published';
      if (statusInput) statusInput.value = status;
      // Update UI text for status
      const statusOption = statusOptions?.querySelector(`[data-value="${status}"]`);
      if (statusOption && statusText) {
          statusText.textContent = statusOption.textContent;
          statusOptions?.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
          statusOption.classList.add('selected');
      }

      // Tags
      if (book.tags) {
          try {
              bookTags = typeof book.tags === 'string' ? JSON.parse(book.tags) : book.tags;
          } catch (e) {
              bookTags = [];
          }
          renderBookTags();
      }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const title = formData.get('title') as string;
    const cover = formData.get('cover') as string;
    const url = formData.get('url') as string;
    
    // Validation
    if (!title?.trim()) {
        window.showAdminAlert('Please enter a book title', 'error');
        return;
    }
    if (!cover?.trim()) {
        window.showAdminAlert('Please enter a cover URL', 'error');
        return;
    }
    if (!url?.trim()) {
        window.showAdminAlert('Please enter a book URL', 'error');
        return;
    }
    if (bookTags.length === 0) {
        window.showAdminAlert('Please add at least one tag', 'error');
        return;
    }

    formData.set('tags', JSON.stringify(bookTags));

    const isEdit = !!bookIdInput?.value;
    const apiUrl = isEdit 
        ? `http://127.0.0.1:8000/api/admin/books/${bookIdInput.value}`
        : `http://127.0.0.1:8000/api/admin/books/upload`;
    
    const method = isEdit ? 'PUT' : 'POST';

    try {
      const response = await fetch(apiUrl, {
        method: method,
        body: formData
      });

      if (response.ok) {
        const successMsg = isEdit ? 'Book updated successfully!' : 'Book created successfully!';
        window.showAdminAlert(successMsg, 'success');
        resetBookForm();
        
        // Refresh the list (dispatch event or reload)
        setTimeout(() => window.location.reload(), 1000);
      } else {
        const error = await response.json();
        const msg = error.detail || error.message || 'Failed to save book';
        window.showAdminAlert(msg, 'error');
      }
    } catch (err) {
      console.error('Error saving book:', err);
      window.showAdminAlert('An error occurred while saving the book.', 'error');
    }
  });
</script>
