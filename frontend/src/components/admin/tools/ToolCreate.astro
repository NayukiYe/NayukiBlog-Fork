---
// ToolCreate.astro
---

<div class="create-card">
  <div class="card-header">
    <div style="display:flex; align-items:center; gap:10px;">
        <h3 class="card-title" id="toolCardTitle">New Tool</h3>
        <button type="button" id="resetToolBtn" class="btn-reset hidden" style="background:none;border:none;cursor:pointer;color:#666;font-size:0.8rem;"><i class="fas fa-times"></i> Cancel</button>
    </div>
    <button type="submit" form="create-tool-form" class="btn-submit-header" id="toolSubmitBtn">
      <i class="fas fa-plus"></i> Add
    </button>
  </div>

  <form id="create-tool-form" class="create-form" novalidate>
    <input type="hidden" name="tool_id" id="toolIdInput">
    
    <!-- Icon URL -->
    <div class="form-row">
      <div class="form-group icon-group">
        <label>Icon SVG</label>
        <input type="url" name="icon" class="form-input" placeholder="<svg>">
      </div>
    </div>

    <!-- Name & Description -->
    <div class="form-row">
      <div class="form-group name-group">
        <label>Name</label>
        <input type="text" name="name" required class="form-input" placeholder="Tool Name">
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group desc-group">
        <label>Description</label>
        <input type="text" name="description" class="form-input" placeholder="Short description...">
      </div>
    </div>

    <!-- URL -->
    <div class="form-row">
      <div class="form-group url-group">
        <label>Tool URL</label>
        <input type="url" name="url" required class="form-input" placeholder="https://tool-link.com">
      </div>
    </div>

    <!-- Category & Status -->
    <div class="form-row">
      <div class="form-group category-group">
        <label>Category</label>
        <input type="text" name="category" class="form-input" placeholder="Add Category">
      </div>

      <div class="form-group status-group">
        <label>Status</label>
        <div class="custom-select-wrapper upward" id="createStatusWrapper">
          <div class="custom-select-trigger" id="createStatusTrigger">
            <span class="current-text">Published</span>
            <input type="hidden" name="status" value="published">
            <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
          <div class="custom-options hidden" id="createStatusOptions">
            <div class="custom-option selected" data-value="published">Published</div>
            <div class="custom-option" data-value="draft">Draft</div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<style>
  .create-card {
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 1px solid #eee;
    height: 500px; /* Fixed height to match filter */
    display: flex;
    flex-direction: column;
    gap: 1rem;
    box-sizing: border-box;
  }

  .card-header {
    padding-bottom: 0.8rem;
    border-bottom: 1px solid #eee;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #333;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .create-form {
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    flex: 1;
    overflow-y: auto;
  }

  .form-row {
    display: flex;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    flex: 1;
  }

  .icon-group { flex: 1; }
  .name-group { flex: 1; }
  .desc-group { flex: 1; }
  .url-group { flex: 1; }
  .category-group { flex: 1; }
  .status-group { flex: 1; }

  label {
    font-size: 0.8rem;
    color: #666;
    font-weight: 500;
  }

  .form-input {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.85rem;
    width: 100%;
    box-sizing: border-box;
    height: 36px;
    font-family: inherit;
  }

  .form-input:focus {
    border-color: #000;
    outline: none;
  }

  /* Custom Select */
  .custom-select-wrapper {
    position: relative;
    width: 100%;
  }

  .custom-select-trigger {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0 0.6rem;
    cursor: pointer;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 36px;
    font-size: 0.85rem;
    color: #333;
    box-sizing: border-box;
  }

  .custom-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 4px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 4px;
  }

  .custom-select-wrapper.upward .custom-options {
    top: auto;
    bottom: 100%;
    margin-top: 0;
    margin-bottom: 4px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
  }

  .custom-options.hidden { display: none; }

  .custom-option {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.85rem;
    color: #444;
  }

  .custom-option:hover { background: #f5f5f7; }
  .custom-option.selected { background: #f0f7ff; color: #0066cc; }

  .btn-submit-header {
    background: #000;
    color: white;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    transition: background 0.2s;
  }

  .btn-submit-header:hover {
    background: #333;
  }

  .btn-submit-header.edit-mode {
    background: #0066cc;
  }
  
  .btn-submit-header.edit-mode:hover {
    background: #0052a3;
  }
</style>

<script>
  // Generic Dropdown Handler
  function setupDropdown(wrapperId: string, triggerId: string, optionsId: string) {
    const wrapper = document.getElementById(wrapperId);
    const trigger = document.getElementById(triggerId);
    const options = document.getElementById(optionsId);
    const input = wrapper?.querySelector('input');
    const textDisplay = wrapper?.querySelector('.current-text');

    trigger?.addEventListener('click', (e) => {
      e.stopPropagation();
      // Close other dropdowns
      document.querySelectorAll('.custom-options').forEach(el => {
        if (el.id !== optionsId) el.classList.add('hidden');
      });
      options?.classList.toggle('hidden');
    });

    options?.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.classList.contains('custom-option')) {
        const value = target.getAttribute('data-value');
        const text = target.textContent;
        
        options.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
        target.classList.add('selected');
        
        if (textDisplay) textDisplay.textContent = text;
        if (input) input.value = value || '';
        
        options.classList.add('hidden');
      }
    });
  }

  setupDropdown('createStatusWrapper', 'createStatusTrigger', 'createStatusOptions');

  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (!target.closest('.custom-select-wrapper')) {
      document.querySelectorAll('.custom-options').forEach(el => el.classList.add('hidden'));
    }
  });

  // Form Submit
  const form = document.getElementById('create-tool-form') as HTMLFormElement;
  const idInput = document.getElementById('toolIdInput') as HTMLInputElement;
  const cardTitle = document.getElementById('toolCardTitle');
  const submitBtn = document.getElementById('toolSubmitBtn');
  const resetBtn = document.getElementById('resetToolBtn');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const toolId = idInput.value;
    const isEdit = !!toolId;

    // Validation
    const name = formData.get('name');
    const url = formData.get('url');
    
    if (!name) {
        window.showAdminAlert('Please enter a tool name', 'error');
        return;
    }
    if (!url) {
        window.showAdminAlert('Please enter a tool URL', 'error');
        return;
    }

    try {
      const urlEndpoint = isEdit 
        ? `http://127.0.0.1:8000/api/admin/tools/${toolId}`
        : 'http://127.0.0.1:8000/api/admin/tools/upload';
      
      const method = isEdit ? 'PUT' : 'POST';

      const response = await fetch(urlEndpoint, {
        method: method,
        body: formData
      });

      if (response.ok) {
        window.showAdminAlert(
            isEdit ? 'Tool updated successfully!' : 'Tool created successfully!', 
            'success'
        );
        if (!isEdit) {
            resetToolForm();
        } else {
            setTimeout(() => {
                resetToolForm();
                window.location.reload();
            }, 1500);
        }
        if (!isEdit) {
            setTimeout(() => window.location.reload(), 1500);
        }
      } else {
        const error = await response.json();
        window.showAdminAlert(error.detail || 'Operation failed', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      window.showAdminAlert('An error occurred. Please try again.', 'error');
    }
  });

  // Edit Mode Handling
  window.addEventListener('edit-tool', ((e: CustomEvent) => {
    const tool = e.detail;
    if (!tool) return;

    // Switch to Edit Mode
    if (cardTitle) cardTitle.textContent = 'Edit Tool';
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Update';
        submitBtn.classList.add('edit-mode');
    }
    if (resetBtn) resetBtn.classList.remove('hidden');
    if (idInput) idInput.value = tool.id;

    // Fill Form
    const nameInput = form.querySelector('input[name="name"]') as HTMLInputElement;
    const urlInput = form.querySelector('input[name="url"]') as HTMLInputElement;
    const descInput = form.querySelector('input[name="description"]') as HTMLInputElement;
    const iconInput = form.querySelector('input[name="icon"]') as HTMLInputElement;
    const categoryInput = form.querySelector('input[name="category"]') as HTMLInputElement;
    
    if (nameInput) nameInput.value = tool.name || '';
    if (urlInput) urlInput.value = tool.url || '';
    if (descInput) descInput.value = tool.description || '';
    if (iconInput) iconInput.value = tool.icon || '';
    if (categoryInput) categoryInput.value = tool.category || '';

    // Helper to set dropdown
    const setDropdown = (wrapperId: string, value: string, text: string) => {
        const wrapper = document.getElementById(wrapperId);
        const input = wrapper?.querySelector('input');
        const textDisplay = wrapper?.querySelector('.current-text');
        const options = wrapper?.querySelector('.custom-options');
        
        if (input) input.value = value;
        if (textDisplay) textDisplay.textContent = text;
        
        options?.querySelectorAll('.custom-option').forEach(opt => {
            if (opt.getAttribute('data-value') === String(value)) {
                opt.classList.add('selected');
            } else {
                opt.classList.remove('selected');
            }
        });
    };

    // Set Dropdowns
    setDropdown('createStatusWrapper', tool.status || 'published', (tool.status || 'published').charAt(0).toUpperCase() + (tool.status || 'published').slice(1));

    // Scroll to view
    const card = document.querySelector('.create-card');
    card?.scrollIntoView({ behavior: 'smooth', block: 'center' });

  }) as EventListener);

  // Reset Logic
  function resetToolForm() {
    form.reset();
    if (idInput) idInput.value = '';

    if (cardTitle) cardTitle.textContent = 'New Tool';
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add';
        submitBtn.classList.remove('edit-mode');
    }
    if (resetBtn) resetBtn.classList.add('hidden');

    // Reset Dropdowns to defaults
    const setDropdown = (wrapperId: string, value: string, text: string) => {
        const wrapper = document.getElementById(wrapperId);
        const input = wrapper?.querySelector('input');
        const textDisplay = wrapper?.querySelector('.current-text');
        const options = wrapper?.querySelector('.custom-options');
        
        if (input) input.value = value;
        if (textDisplay) textDisplay.textContent = text;
        
        options?.querySelectorAll('.custom-option').forEach(opt => {
            if (opt.getAttribute('data-value') === String(value)) {
                opt.classList.add('selected');
            } else {
                opt.classList.remove('selected');
            }
        });
    };

    setDropdown('createStatusWrapper', 'published', 'Published');
  }

  resetBtn?.addEventListener('click', resetToolForm);
</script>
