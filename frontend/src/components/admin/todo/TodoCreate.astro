---
// TodoCreate.astro
---

<div class="create-card">
  <div class="card-header">
    <div style="display:flex; align-items:center; gap:10px;">
        <h3 class="card-title" id="todoCardTitle">New Task</h3>
        <button type="button" id="resetTodoBtn" class="btn-reset hidden" style="background:none;border:none;cursor:pointer;color:#666;font-size:0.8rem;"><i class="fas fa-times"></i> Cancel</button>
    </div>
    <button type="submit" form="create-todo-form" class="btn-submit-header" id="todoSubmitBtn">
      <i class="fas fa-plus"></i> Add
    </button>
  </div>

  <form id="create-todo-form" class="create-form" novalidate>
    <input type="hidden" name="todo_id" id="todoIdInput">
    <!-- Icon -->
    <div class="form-row">
      <div class="form-group icon-group">
        <label>Icon URL</label>
        <input type="url" name="icon" class="form-input" placeholder="https://example.com/icon.svg">
      </div>
    </div>

    <!-- Task -->
    <div class="form-row">
      <div class="form-group task-group">
        <label>Task</label>
        <input type="text" name="task" required class="form-input" placeholder="Task description...">
      </div>
    </div>

    <!-- Priority & Type -->
    <div class="form-row">
      <div class="form-group priority-group">
        <label>Priority</label>
        <div class="custom-select-wrapper" id="createPriorityWrapper">
          <div class="custom-select-trigger" id="createPriorityTrigger">
            <span class="current-text">Medium</span>
            <input type="hidden" name="priority" value="medium">
            <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
          <div class="custom-options hidden" id="createPriorityOptions">
            <div class="custom-option" data-value="high">High</div>
            <div class="custom-option selected" data-value="medium">Medium</div>
            <div class="custom-option" data-value="low">Low</div>
          </div>
        </div>
      </div>
      <div class="form-group type-group">
        <label>Type</label>
        <div class="custom-select-wrapper" id="createTypeWrapper">
          <div class="custom-select-trigger" id="createTypeTrigger">
            <span class="current-text">Short-term</span>
            <input type="hidden" name="type" value="short-term">
            <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
          <div class="custom-options hidden" id="createTypeOptions">
            <div class="custom-option" data-value="long-term">Long-term</div>
            <div class="custom-option" data-value="medium-term">Medium-term</div>
            <div class="custom-option selected" data-value="short-term">Short-term</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress -->
    <div class="form-row">
      <div class="form-group progress-group">
        <label>Progress (<span id="progress-value">0</span>%)</label>
        <input type="range" name="progress" min="0" max="100" value="0" class="range-input" id="progress-input">
      </div>
    </div>

    <!-- Status 1 (Visibility) & Status 2 (Completion) -->
    <div class="form-row">
      <div class="form-group status-group">
        <label>Visibility</label>
        <div class="custom-select-wrapper upward" id="createStatusWrapper">
          <div class="custom-select-trigger" id="createStatusTrigger">
            <span class="current-text">Published</span>
            <input type="hidden" name="status" value="published">
            <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
          <div class="custom-options hidden" id="createStatusOptions">
            <div class="custom-option selected" data-value="published">Published</div>
            <div class="custom-option" data-value="draft">Draft</div>
          </div>
        </div>
      </div>

      <div class="form-group status-group">
        <label>Completion</label>
        <div class="custom-select-wrapper upward" id="createCompletedWrapper">
          <div class="custom-select-trigger" id="createCompletedTrigger">
            <span class="current-text">Pending</span>
            <input type="hidden" name="completed" value="false">
            <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
          <div class="custom-options hidden" id="createCompletedOptions">
            <div class="custom-option selected" data-value="false">Pending</div>
            <div class="custom-option" data-value="true">Completed</div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<style>
  .create-card {
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 1px solid #eee;
    height: 550px; /* Fixed height to match filter */
    display: flex;
    flex-direction: column;
    gap: 1rem;
    box-sizing: border-box;
  }

  .card-header {
    padding-bottom: 0.8rem;
    border-bottom: 1px solid #eee;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #333;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .create-form {
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    flex: 1;
    overflow-y: auto;
  }

  .form-row {
    display: flex;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    flex: 1;
  }

  .icon-group { flex: 1; }
  .task-group { flex: 2; }
  .priority-group { flex: 1; }
  .type-group { flex: 1; }
  .status-group { flex: 1; }

  label {
    font-size: 0.8rem;
    color: #666;
    font-weight: 500;
  }

  .form-input {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.85rem;
    width: 100%;
    box-sizing: border-box;
    height: 36px;
    font-family: inherit;
  }

  .form-input:focus {
    border-color: #000;
    outline: none;
  }

  /* Range Input */
  .range-input {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    background: #eee;
    border-radius: 3px;
    outline: none;
    margin: 15px 0;
  }

  .range-input::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #000;
    cursor: pointer;
    transition: transform 0.1s;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  .range-input::-webkit-slider-thumb:hover {
    transform: scale(1.1);
  }

  .range-input::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #000;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  /* Custom Select */
  .custom-select-wrapper {
    position: relative;
    width: 100%;
  }

  .custom-select-trigger {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0 0.6rem;
    cursor: pointer;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 36px;
    font-size: 0.85rem;
    color: #333;
    box-sizing: border-box;
  }

  .custom-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 4px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 4px;
  }

  .custom-select-wrapper.upward .custom-options {
    top: auto;
    bottom: 100%;
    margin-top: 0;
    margin-bottom: 4px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
  }

  .custom-options.hidden { display: none; }

  .custom-option {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.85rem;
    color: #444;
  }

  .custom-option:hover { background: #f5f5f7; }
  .custom-option.selected { background: #f0f7ff; color: #0066cc; }

  .form-footer {
    margin-top: auto;
    display: flex;
    justify-content: flex-end;
  }

  .btn-submit {
    background: #000;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-submit:hover {
    background: #333;
  }

  .btn-submit-header {
    background: #000;
    color: white;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    transition: background 0.2s;
  }

  .btn-submit-header:hover {
    background: #333;
  }

  .btn-submit-header.edit-mode {
    background: #0066cc;
  }
  
  .btn-submit-header.edit-mode:hover {
    background: #0052a3;
  }
</style>

<script>
  // Progress Slider
  const progressInput = document.getElementById('progress-input') as HTMLInputElement;
  const progressValue = document.getElementById('progress-value');
  
  progressInput?.addEventListener('input', () => {
    if (progressValue) progressValue.textContent = progressInput.value;
  });

  // Generic Dropdown Handler
  function setupDropdown(wrapperId: string, triggerId: string, optionsId: string) {
    const wrapper = document.getElementById(wrapperId);
    const trigger = document.getElementById(triggerId);
    const options = document.getElementById(optionsId);
    const input = wrapper?.querySelector('input');
    const textDisplay = wrapper?.querySelector('.current-text');

    trigger?.addEventListener('click', (e) => {
      e.stopPropagation();
      // Close other dropdowns
      document.querySelectorAll('.custom-options').forEach(el => {
        if (el.id !== optionsId) el.classList.add('hidden');
      });
      options?.classList.toggle('hidden');
    });

    options?.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.classList.contains('custom-option')) {
        const value = target.getAttribute('data-value');
        const text = target.textContent;
        
        options.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
        target.classList.add('selected');
        
        if (textDisplay) textDisplay.textContent = text;
        if (input) input.value = value || '';
        
        options.classList.add('hidden');
      }
    });
  }

  setupDropdown('createPriorityWrapper', 'createPriorityTrigger', 'createPriorityOptions');
  setupDropdown('createTypeWrapper', 'createTypeTrigger', 'createTypeOptions');
  setupDropdown('createStatusWrapper', 'createStatusTrigger', 'createStatusOptions');
  setupDropdown('createCompletedWrapper', 'createCompletedTrigger', 'createCompletedOptions');

  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (!target.closest('.custom-select-wrapper')) {
      document.querySelectorAll('.custom-options').forEach(el => el.classList.add('hidden'));
    }
  });

  // Form Submit
  const form = document.getElementById('create-todo-form') as HTMLFormElement;
  const idInput = document.getElementById('todoIdInput') as HTMLInputElement;
  const cardTitle = document.getElementById('todoCardTitle');
  const submitBtn = document.getElementById('todoSubmitBtn');
  const resetBtn = document.getElementById('resetTodoBtn');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const todoId = idInput.value;
    const isEdit = !!todoId;

    // Validation
    const task = formData.get('task');
    if (!task) {
        window.showAdminAlert('Please enter a task description', 'error');
        return;
    }

    try {
      const urlEndpoint = isEdit 
        ? `http://127.0.0.1:8000/api/admin/todos/${todoId}`
        : 'http://127.0.0.1:8000/api/admin/todos/upload';
      
      const method = isEdit ? 'PUT' : 'POST';

      const response = await fetch(urlEndpoint, {
        method: method,
        body: formData
      });

      if (response.ok) {
        window.showAdminAlert(
            isEdit ? 'Task updated successfully!' : 'Task created successfully!', 
            'success'
        );
        if (!isEdit) {
            resetTodoForm();
        } else {
            setTimeout(() => {
                resetTodoForm();
                window.location.reload();
            }, 1500);
        }
        if (!isEdit) {
            setTimeout(() => window.location.reload(), 1500);
        }
      } else {
        const error = await response.json();
        window.showAdminAlert(error.detail || 'Operation failed', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      window.showAdminAlert('An error occurred. Please try again.', 'error');
    }
  });

  // Edit Mode Handling
  window.addEventListener('edit-todo', ((e: CustomEvent) => {
    const todo = e.detail;
    if (!todo) return;

    // Switch to Edit Mode
    if (cardTitle) cardTitle.textContent = 'Edit Task';
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Update';
        submitBtn.classList.add('edit-mode');
    }
    if (resetBtn) resetBtn.classList.remove('hidden');
    if (idInput) idInput.value = todo.id;

    // Fill Form
    const taskInput = form.querySelector('input[name="task"]') as HTMLInputElement;
    const iconInput = form.querySelector('input[name="icon"]') as HTMLInputElement;
    const progressInput = form.querySelector('input[name="progress"]') as HTMLInputElement;
    
    if (taskInput) taskInput.value = todo.task || '';
    if (iconInput) iconInput.value = todo.icon || '';
    if (progressInput) {
        progressInput.value = todo.progress || 0;
        if (progressValue) progressValue.textContent = todo.progress || 0;
    }

    // Helper to set dropdown
    const setDropdown = (wrapperId: string, value: string, text: string) => {
        const wrapper = document.getElementById(wrapperId);
        const input = wrapper?.querySelector('input');
        const textDisplay = wrapper?.querySelector('.current-text');
        const options = wrapper?.querySelector('.custom-options');
        
        if (input) input.value = value;
        if (textDisplay) textDisplay.textContent = text;
        
        options?.querySelectorAll('.custom-option').forEach(opt => {
            if (opt.getAttribute('data-value') === String(value)) {
                opt.classList.add('selected');
            } else {
                opt.classList.remove('selected');
            }
        });
    };

    // Set Dropdowns
    setDropdown('createPriorityWrapper', todo.priority?.toLowerCase() || 'medium', todo.priority || 'Medium');
    setDropdown('createTypeWrapper', todo.type || 'short-term', (todo.type || 'short-term').charAt(0).toUpperCase() + (todo.type || 'short-term').slice(1));
    setDropdown('createStatusWrapper', todo.status || 'published', (todo.status || 'published').charAt(0).toUpperCase() + (todo.status || 'published').slice(1));
    setDropdown('createCompletedWrapper', String(todo.completed), todo.completed ? 'Completed' : 'Pending');

    // Scroll to view
    const card = document.querySelector('.create-card');
    card?.scrollIntoView({ behavior: 'smooth', block: 'center' });

  }) as EventListener);

  // Reset Logic
  function resetTodoForm() {
    form.reset();
    if (idInput) idInput.value = '';
    if (progressValue) progressValue.textContent = '0';

    if (cardTitle) cardTitle.textContent = 'New Task';
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add';
        submitBtn.classList.remove('edit-mode');
    }
    if (resetBtn) resetBtn.classList.add('hidden');

    // Reset Dropdowns to defaults
    const setDropdown = (wrapperId: string, value: string, text: string) => {
        const wrapper = document.getElementById(wrapperId);
        const input = wrapper?.querySelector('input');
        const textDisplay = wrapper?.querySelector('.current-text');
        const options = wrapper?.querySelector('.custom-options');
        
        if (input) input.value = value;
        if (textDisplay) textDisplay.textContent = text;
        
        options?.querySelectorAll('.custom-option').forEach(opt => {
            if (opt.getAttribute('data-value') === String(value)) {
                opt.classList.add('selected');
            } else {
                opt.classList.remove('selected');
            }
        });
    };

    setDropdown('createPriorityWrapper', 'medium', 'Medium');
    setDropdown('createTypeWrapper', 'short-term', 'Short-term');
    setDropdown('createStatusWrapper', 'published', 'Published');
    setDropdown('createCompletedWrapper', 'false', 'Pending');
  }

  resetBtn?.addEventListener('click', resetTodoForm);
</script>
