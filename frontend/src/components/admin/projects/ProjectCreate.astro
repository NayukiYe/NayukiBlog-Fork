---
// ProjectCreate.astro
---

<div class="create-card">
  <div class="create-header">
    <h3 class="create-title">创建项目</h3>
    <button class="btn-reset">重置</button>
  </div>
  
  <div class="create-content">
    <form class="create-form" onsubmit="event.preventDefault();">
      <!-- Project Name -->
      <div class="form-group">
        <label class="form-label">项目名称</label>
        <input type="text" id="projectName" class="form-input" placeholder="Project Name" />
        <input type="hidden" id="projectId" />
      </div>

      <!-- Description -->
      <div class="form-group">
        <label class="form-label">描述</label>
        <textarea id="projectDesc" class="form-input textarea" rows="3" placeholder="Project Description"></textarea>
      </div>

      <!-- Tech Stack -->
      <div class="form-group">
        <label class="form-label">技术栈</label>
        <div class="tags-input-container" id="createTechStackContainer">
          <div class="create-selected-tags" id="createSelectedTags">
            <!-- Tags will be added here -->
          </div>
          <div class="create-tag-wrapper">
            <input type="text" class="create-tag-input" id="createTagInput" placeholder="Add tech..." />
            <button type="button" class="create-tag-confirm-btn" id="createConfirmTagBtn">
              <i class="fas fa-check"></i>
            </button>
            <div class="create-tags-dropdown hidden" id="createTechStackDropdown">
              <!-- Options populated via JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- URL & Status -->
      <div class="form-row">
        <div class="form-group half">
          <label class="form-label">项目链接</label>
          <input type="text" id="projectLink" class="form-input" placeholder="https://example.com/project" />
        </div>
        <div class="form-group half">
          <label class="form-label">状态</label>
          <div class="custom-select-wrapper" id="createStatusWrapper">
            <div class="custom-select-trigger" id="createStatusTrigger">
              <span class="current-text">Planning</span>
              <input type="hidden" name="status" value="planning">
              <i class="fas fa-chevron-down arrow-icon"></i>
            </div>
            <div class="custom-options hidden" id="createStatusOptions">
              <div class="custom-option selected" data-value="planning">Planning</div>
              <div class="custom-option" data-value="in-progress">In Progress</div>
              <div class="custom-option" data-value="completed">Completed</div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn-submit" id="submitBtn">
          <i class="fas fa-plus"></i> 创建
        </button>
      </div>
    </form>
  </div>
</div>

<style>
  :global(.create-card) {
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    border: 1px solid #eee;
    height: 360px;
    box-sizing: border-box;
  }

  :global(.create-header) {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
    flex-shrink: 0;
  }

  :global(.create-content) {
    overflow-y: auto;
    flex: 1;
    padding-right: 4px;
  }

  :global(.create-content::-webkit-scrollbar) {
    width: 4px;
  }
  
  :global(.create-content::-webkit-scrollbar-track) {
    background: transparent;
  }
  
  :global(.create-content::-webkit-scrollbar-thumb) {
    background: #ddd;
    border-radius: 4px;
  }

  :global(.create-title) {
    font-size: 0.75rem;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  :global(.btn-reset) {
    background: none;
    border: none;
    color: #666;
    font-size: 0.85rem;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s;
  }

  :global(.btn-reset:hover) {
    background: #f5f5f5;
    color: #d32f2f;
  }

  :global(.create-form) {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  :global(.form-group) {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  :global(.form-row) {
    display: flex;
    gap: 1rem;
  }

  :global(.form-group.half) {
    flex: 1;
  }

  :global(.form-label) {
    font-size: 0.85rem;
    color: #666;
    font-weight: 500;
  }

  :global(.form-input), :global(.form-select) {
    padding: 0.6rem 0.8rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    color: #333;
    transition: border-color 0.2s;
    width: 100%;
    box-sizing: border-box;
    font-family: inherit;
  }

  :global(.form-input:focus), :global(.form-select:focus) {
    border-color: #000;
    outline: none;
  }

  :global(.form-input.textarea) {
    resize: vertical;
    min-height: 80px;
  }

  :global(.custom-select-wrapper) {
    position: relative;
  }

  :global(.custom-select-trigger) {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0.6rem 0.8rem;
    cursor: pointer;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: border-color 0.2s;
    font-size: 0.9rem;
    color: #333;
    box-sizing: border-box;
    min-height: 38px;
  }

  :global(.custom-select-trigger:hover) {
    border-color: #000;
  }

  :global(.custom-options) {
    position: absolute;
    bottom: 100%;
    margin-bottom: 6px;
    left: 0;
    right: 0;
    top: auto;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    padding: 4px;
  }

  :global(.custom-options.hidden) {
    display: none;
  }

  :global(.custom-option) {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.9rem;
    color: #444;
    transition: all 0.2s;
    border-radius: 4px;
  }

  :global(.custom-option:hover) {
    background: #f5f5f7;
    color: #000;
  }

  :global(.custom-option.selected) {
    background: #f0f7ff;
    color: #0066cc;
    font-weight: 500;
  }

  :global(.arrow-icon) {
    color: #999;
    font-size: 0.8rem;
    pointer-events: none;
  }

  /* Tags Input */
  :global(.tags-input-container) {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0.4rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    background: #fff;
    min-height: 40px;
    box-sizing: border-box;
  }

  :global(.tags-input-container:focus-within) {
    border-color: #000;
  }

  :global(.create-selected-tags) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  :global(.create-tag) {
    background: #f0f0f0;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    color: #333;
  }

  :global(.create-tag i) {
    cursor: pointer;
    font-size: 0.8rem;
    color: #999;
    transition: color 0.2s;
  }

  :global(.create-tag i:hover) {
    color: #d32f2f;
  }

  :global(.create-tag-input) {
    border: none;
    outline: none;
    flex: 1;
    min-width: 60px;
    font-size: 0.9rem;
    padding: 0.2rem;
    background: transparent;
  }

  :global(.create-tag-wrapper) {
    position: relative;
    display: flex;
    align-items: center;
    flex: 1;
    min-width: 120px;
  }

  :global(.create-tag-confirm-btn) {
    background: none;
    border: none;
    color: #4caf50;
    cursor: pointer;
    padding: 4px 8px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    transition: color 0.2s;
  }
  
  :global(.create-tag-confirm-btn:hover) {
    color: #388e3c;
  }

  :global(.create-tags-dropdown) {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background: white;
    border: 1px solid #eee;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    max-height: 150px;
    overflow-y: auto;
    z-index: 100;
    margin-top: 4px;
  }

  :global(.create-tags-dropdown.hidden) {
    display: none;
  }

  :global(.create-tag-suggestion) {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.9rem;
    color: #333;
  }

  :global(.create-tag-suggestion:hover) {
    background: #f5f5f5;
  }

  :global(.form-actions) {
    margin-top: 0.5rem;
  }

  :global(.btn-submit) {
    width: 100%;
    background: #000;
    color: #fff;
    border: none;
    padding: 0.75rem;
    border-radius: 6px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-submit:hover {
    background: #333;
  }
</style>

<script>
  const wrapper = document.getElementById('createStatusWrapper');
  const trigger = document.getElementById('createStatusTrigger');
  const options = document.getElementById('createStatusOptions');
  const hiddenInput = trigger?.querySelector('input');
  const currentText = trigger?.querySelector('.current-text');

  trigger?.addEventListener('click', (e) => {
    e.stopPropagation();
    options?.classList.toggle('hidden');
  });

  options?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.classList.contains('custom-option')) {
      const value = target.getAttribute('data-value');
      const text = target.textContent;
      
      // Update UI
      options.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
      target.classList.add('selected');
      if (currentText) currentText.textContent = text;
      if (hiddenInput) hiddenInput.value = value || '';
      
      options.classList.add('hidden');
    }
  });

  document.addEventListener('click', (e) => {
    if (!wrapper?.contains(e.target as Node)) {
      options?.classList.add('hidden');
    }
  });

  // Tag Handling
  const tagInput = document.getElementById('createTagInput') as HTMLInputElement;
  const confirmTagBtn = document.getElementById('createConfirmTagBtn');
  const techStackDropdown = document.getElementById('createTechStackDropdown');
  const selectedTagsContainer = document.getElementById('createSelectedTags');
  let tags: string[] = [];
  let availableStacks: string[] = [];

  // Fetch available stacks
  async function fetchTechStacks() {
    try {
      const res = await fetch('http://127.0.0.1:8000/api/admin/projects/tech-stacks');
      if (res.ok) {
        availableStacks = await res.json();
      }
    } catch (e) {
      console.error('Failed to fetch tech stacks', e);
    }
  }
  fetchTechStacks();

  function renderTags() {
    if (!selectedTagsContainer) return;
    selectedTagsContainer.innerHTML = tags.map(tag => `
      <span class="create-tag">
        ${tag}
        <i class="fas fa-times" data-tag="${tag}"></i>
      </span>
    `).join('');
    
    // Re-attach remove listeners
    selectedTagsContainer.querySelectorAll('.create-tag i').forEach(icon => {
        icon.addEventListener('click', (e) => {
            const tagToRemove = (e.target as HTMLElement).getAttribute('data-tag');
            if (tagToRemove) removeTag(tagToRemove);
        });
    });
  }

  function removeTag(tagToRemove: string) {
    tags = tags.filter(t => t !== tagToRemove);
    renderTags();
    filterDropdown(tagInput.value);
  }

  function addTag(val: string) {
    val = val.trim();
    if (val && !tags.includes(val)) {
      tags.push(val);
      tagInput.value = '';
      renderTags();
      filterDropdown('');
    }
  }

  // Dropdown Logic
  function filterDropdown(query: string) {
    if (!techStackDropdown) return;
    
    const filtered = availableStacks.filter(s => 
      s.toLowerCase().includes(query.toLowerCase()) && !tags.includes(s)
    );

    if (filtered.length > 0) {
      techStackDropdown.innerHTML = filtered.map(s => `
        <div class="create-tag-suggestion" data-value="${s}">${s}</div>
      `).join('');
      techStackDropdown.classList.remove('hidden');
    } else {
      techStackDropdown.classList.add('hidden');
    }
  }

  tagInput?.addEventListener('focus', () => {
    filterDropdown(tagInput.value);
  });

  tagInput?.addEventListener('input', () => {
    filterDropdown(tagInput.value);
  });

  // Click outside to close dropdown
  document.addEventListener('click', (e) => {
    if (!tagInput?.contains(e.target as Node) && !techStackDropdown?.contains(e.target as Node)) {
      techStackDropdown?.classList.add('hidden');
    }
  });

  // Select from dropdown
  techStackDropdown?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.classList.contains('create-tag-suggestion')) {
      const val = target.getAttribute('data-value');
      if (val) addTag(val);
      tagInput?.focus();
    }
  });

  // Confirm Button
  confirmTagBtn?.addEventListener('click', () => {
    addTag(tagInput.value);
  });

  tagInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addTag(tagInput.value);
    }
  });

  // Form Submission
  const submitBtn = document.getElementById('submitBtn');
  const projectIdInput = document.getElementById('projectId') as HTMLInputElement;
  const nameInput = document.getElementById('projectName') as HTMLInputElement;
  const descInput = document.getElementById('projectDesc') as HTMLTextAreaElement;
  const linkInput = document.getElementById('projectLink') as HTMLInputElement;
  const statusInput = document.querySelector('input[name="status"]') as HTMLInputElement;
  const createTitle = document.querySelector('.create-title');

  submitBtn?.addEventListener('click', async (e) => {
    e.preventDefault();
    
    // Validation
    if (!nameInput.value.trim()) {
        window.showAdminAlert ? window.showAdminAlert('Project name is required', 'error') : alert('Project name is required');
        return;
    }
    if (!descInput.value.trim()) {
        window.showAdminAlert ? window.showAdminAlert('Description is required', 'error') : alert('Description is required');
        return;
    }
    if (tags.length === 0) {
        window.showAdminAlert ? window.showAdminAlert('Please add at least one tech stack', 'error') : alert('Please add at least one tech stack');
        return;
    }

    const formData = new FormData();
    formData.append('name', nameInput.value);
    formData.append('description', descInput.value);
    formData.append('link', linkInput.value);
    formData.append('techStack', JSON.stringify(tags));
    formData.append('status', statusInput.value);
    // No image field!

    const isEdit = !!projectIdInput.value;
    const url = isEdit 
        ? `http://127.0.0.1:8000/api/admin/projects/${projectIdInput.value}`
        : `http://127.0.0.1:8000/api/admin/projects/upload`;
    
    const method = isEdit ? 'PUT' : 'POST';

    try {
        const res = await fetch(url, {
            method: method,
            body: formData
        });

        if (res.ok) {
            resetForm();
            window.dispatchEvent(new CustomEvent('project-created')); // Refresh list
            if (window.showAdminAlert) {
                window.showAdminAlert(isEdit ? 'Project updated!' : 'Project created!', 'success');
            } else {
                alert(isEdit ? 'Project updated!' : 'Project created!');
            }
        } else {
            if (window.showAdminAlert) {
                window.showAdminAlert('Operation failed', 'error');
            } else {
                alert('Operation failed');
            }
        }
    } catch (err) {
        console.error(err);
        if (window.showAdminAlert) {
            window.showAdminAlert('Error occurred', 'error');
        } else {
            alert('Error occurred');
        }
    }
  });

  // Reset
  const resetBtn = document.querySelector('.btn-reset');
  resetBtn?.addEventListener('click', resetForm);

  function resetForm() {
    if (projectIdInput) projectIdInput.value = '';
    if (nameInput) nameInput.value = '';
    if (descInput) descInput.value = '';
    if (linkInput) linkInput.value = '';
    tags = [];
    renderTags();
    
    // Reset status to default
    if (statusInput) statusInput.value = 'planning';
    const statusText = document.querySelector('#createStatusTrigger .current-text');
    if (statusText) statusText.textContent = 'Planning';
    document.querySelectorAll('.custom-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.getAttribute('data-value') === 'planning') opt.classList.add('selected');
    });

    if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-plus"></i> 创建';
    if (createTitle) createTitle.textContent = '创建项目';
  }

  // Listen for Edit
  window.addEventListener('edit-project', (e: any) => {
    const project = e.detail;
    if (!project) return;

    if (projectIdInput) projectIdInput.value = project.id;
    if (nameInput) nameInput.value = project.name;
    if (descInput) descInput.value = project.description || '';
    if (linkInput) linkInput.value = project.link || '';
    
    tags = project.techStack || [];
    renderTags();

    // Set status
    const status = project.status?.toLowerCase() || 'planning';
    if (statusInput) statusInput.value = status;
    const statusText = document.querySelector('#createStatusTrigger .current-text');
    // Find text for status
    const option = document.querySelector(`.custom-option[data-value="${status}"]`);
    if (statusText && option) statusText.textContent = option.textContent;
    
    document.querySelectorAll('.custom-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.getAttribute('data-value') === status) opt.classList.add('selected');
    });

    if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-save"></i> 更新';
    if (createTitle) createTitle.textContent = '编辑项目';
  });
</script>
