---
// DiaryFilter.astro
---

<div class="filter-card">
  <div class="filter-header">
    <h3 class="filter-title">筛选条件</h3>
    <button id="resetFiltersBtn" class="reset-btn">重置</button>
  </div>

  <div class="filter-row">
    <!-- Year Filter -->
    <div class="filter-group">
      <label>年份</label>
      <div class="year-input-wrapper">
        <input 
          type="number" 
          id="yearInput" 
          class="filter-input" 
          placeholder="输入年份 (如: 2025)" 
          min="2000" 
          max="2100"
        />
      </div>
    </div>

    <!-- Month Filter -->
    <div class="filter-group">
      <label>月份</label>
      <div class="custom-select-wrapper" id="monthSelectWrapper">
        <div class="custom-select-trigger" id="monthTrigger">
          <span class="current-text" id="monthText">全部月份</span>
          <i class="fas fa-chevron-down arrow-icon"></i>
        </div>
        <div class="custom-options hidden" id="monthOptions">
          <div class="custom-option selected" data-value="">全部月份</div>
          <div class="custom-option" data-value="1">1月</div>
          <div class="custom-option" data-value="2">2月</div>
          <div class="custom-option" data-value="3">3月</div>
          <div class="custom-option" data-value="4">4月</div>
          <div class="custom-option" data-value="5">5月</div>
          <div class="custom-option" data-value="6">6月</div>
          <div class="custom-option" data-value="7">7月</div>
          <div class="custom-option" data-value="8">8月</div>
          <div class="custom-option" data-value="9">9月</div>
          <div class="custom-option" data-value="10">10月</div>
          <div class="custom-option" data-value="11">11月</div>
          <div class="custom-option" data-value="12">12月</div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .filter-card {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    margin-bottom: 0; /* Removed margin to fit in grid */
    border: 1px solid #f0f0f0;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    height: 100%; /* Stretch to fill container */
    box-sizing: border-box;
  }

  .filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 0.8rem;
    border-bottom: 1px solid #f5f5f5;
  }

  .filter-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filter-title::before {
    content: '';
    width: 4px;
    height: 16px;
    background: #409eff;
    border-radius: 2px;
  }

  .reset-btn {
    background: #f5f7fa;
    border: 1px solid #e4e7ed;
    color: #606266;
    font-size: 0.8rem;
    cursor: pointer;
    padding: 5px 12px;
    border-radius: 6px;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .reset-btn:hover {
    background: #fef0f0;
    color: #f56c6c;
    border-color: #fbc4c4;
  }

  .filter-row {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    width: 100%;
  }

  .filter-group label {
    font-size: 0.85rem;
    color: #909399;
    font-weight: 500;
    margin-left: 2px;
  }

  /* Input Styling */
  .filter-input {
    width: 100%;
    padding: 10px 14px;
    background: #fff;
    border: 1px solid #dcdfe6;
    border-radius: 8px;
    font-size: 0.9rem;
    color: #606266;
    transition: all 0.2s;
    outline: none;
    box-sizing: border-box;
  }

  .filter-input:focus {
    border-color: #409eff;
    box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.1);
  }

  .filter-input::placeholder {
    color: #c0c4cc;
  }

  /* Custom Select Styling */
  .custom-select-wrapper {
    position: relative;
    width: 100%;
  }

  .custom-select-trigger {
    padding: 10px 14px;
    background: #fff;
    border: 1px solid #dcdfe6;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: #606266;
    transition: all 0.2s;
  }

  .custom-select-trigger:hover {
    border-color: #c0c4cc;
  }

  .custom-select-trigger.active {
    border-color: #409eff;
    box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.1);
  }

  .arrow-icon {
    font-size: 0.8rem;
    transition: transform 0.3s;
    color: #c0c4cc;
  }

  .custom-select-trigger.active .arrow-icon {
    transform: rotate(180deg);
  }

  .custom-options {
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #e4e7ed;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    z-index: 100;
    max-height: 250px;
    overflow-y: auto;
    padding: 6px;
  }

  .custom-options.hidden {
    display: none;
  }

  :global(.custom-option) {
    padding: 10px 12px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 0.9rem;
    color: #606266;
    transition: all 0.2s;
  }

  :global(.custom-option:hover) {
    background-color: #f5f7fa;
    color: #409eff;
  }

  :global(.custom-option.selected) {
    background-color: #ecf5ff;
    color: #409eff;
    font-weight: 600;
  }

  /* Scrollbar styling */
  .custom-options::-webkit-scrollbar {
    width: 6px;
  }
  .custom-options::-webkit-scrollbar-thumb {
    background: #e4e7ed;
    border-radius: 3px;
  }
  .custom-options::-webkit-scrollbar-track {
    background: transparent;
  }
</style>

<script>
  const yearInput = document.getElementById('yearInput') as HTMLInputElement;
  const monthTrigger = document.getElementById('monthTrigger');
  const monthOptions = document.getElementById('monthOptions');
  const monthText = document.getElementById('monthText');
  const resetBtn = document.getElementById('resetFiltersBtn');

  let selectedYear = '';
  let selectedMonth = '';

  // Initialize from URL
  function initFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    selectedYear = urlParams.get('year') || '';
    selectedMonth = urlParams.get('month') || '';

    if (yearInput) yearInput.value = selectedYear;
    updateSelectUI('month', selectedMonth);
  }

  function updateSelectUI(type: 'month', value: string) {
    const optionsContainer = monthOptions;
    const textElement = monthText;
    
    if (!optionsContainer || !textElement) return;

    const options = optionsContainer.querySelectorAll('.custom-option');
    options.forEach(opt => {
      const option = opt as HTMLElement;
      if (option.dataset.value === value) {
        option.classList.add('selected');
        textElement.textContent = option.textContent;
      } else {
        option.classList.remove('selected');
      }
    });

    if (value === '') {
      textElement.textContent = '全部月份';
    }
  }

  function toggleDropdown(trigger: HTMLElement, options: HTMLElement) {
    const isActive = trigger.classList.contains('active');
    
    // Close all first
    document.querySelectorAll('.custom-select-trigger').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.custom-options').forEach(o => o.classList.add('hidden'));

    if (!isActive) {
      trigger.classList.add('active');
      options.classList.remove('hidden');
    }
  }

  yearInput?.addEventListener('input', (e) => {
    selectedYear = (e.target as HTMLInputElement).value;
    updateUrl();
  });

  monthTrigger?.addEventListener('click', (e) => {
    e.stopPropagation();
    if (monthTrigger && monthOptions) toggleDropdown(monthTrigger, monthOptions);
  });

  document.addEventListener('click', () => {
    document.querySelectorAll('.custom-select-trigger').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.custom-options').forEach(o => o.classList.add('hidden'));
  });

  monthOptions?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.classList.contains('custom-option')) {
      selectedMonth = target.dataset.value || '';
      updateUrl();
    }
  });

  function updateUrl() {
    const url = new URL(window.location.href);
    
    if (selectedYear) url.searchParams.set('year', selectedYear);
    else url.searchParams.delete('year');

    if (selectedMonth) url.searchParams.set('month', selectedMonth);
    else url.searchParams.delete('month');

    url.searchParams.set('page', '1');

    window.history.pushState({}, '', url.toString());
    window.dispatchEvent(new CustomEvent('diary-filter-change'));
    
    updateSelectUI('month', selectedMonth);
  }

  resetBtn?.addEventListener('click', () => {
    selectedYear = '';
    selectedMonth = '';
    if (yearInput) yearInput.value = '';
    updateUrl();
  });

  initFromUrl();
</script>
