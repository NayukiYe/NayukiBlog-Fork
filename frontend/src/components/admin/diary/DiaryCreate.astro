---
// DiaryCreate.astro
---

<div class="create-card">
  <div class="card-header">
    <h3 class="card-title">New Diary Entry</h3>
    <button class="btn-reset">Reset</button>
  </div>
  
  <form id="create-diary-form" class="create-form" onsubmit="event.preventDefault();">
    <input type="hidden" id="diaryId" name="diary_id" />

    <div class="form-row">
      <div class="form-group date-group">
        <label>Time</label>
        <input type="datetime-local" name="date" required class="form-input" id="diary-date-input">
      </div>
      
      <div class="form-group mood-group">
        <label>Mood</label>
        <div class="custom-select-wrapper" id="moodSelectWrapper">
            <div class="custom-select-trigger" id="moodTrigger">
                <span class="current-text">Happy</span>
                <input type="hidden" name="mood" value="happy" id="moodInput">
                <i class="fas fa-chevron-down arrow-icon"></i>
            </div>
            <div class="custom-options hidden" id="moodOptions">
                <div class="custom-option selected" data-value="happy">Happy</div>
                <div class="custom-option" data-value="neutral">Neutral</div>
                <div class="custom-option" data-value="sad">Sad</div>
                <div class="custom-option" data-value="excited">Excited</div>
                <div class="custom-option" data-value="tired">Tired</div>
                <div class="custom-option" data-value="angry">Angry</div>
            </div>
        </div>
      </div>

      <div class="form-group weather-group">
        <label>Weather</label>
        <div class="custom-select-wrapper" id="weatherSelectWrapper">
            <div class="custom-select-trigger" id="weatherTrigger">
                <span class="current-text">Sunny</span>
                <input type="hidden" name="weather" value="sunny" id="weatherInput">
                <i class="fas fa-chevron-down arrow-icon"></i>
            </div>
            <div class="custom-options hidden" id="weatherOptions">
                <div class="custom-option selected" data-value="sunny">Sunny</div>
                <div class="custom-option" data-value="cloudy">Cloudy</div>
                <div class="custom-option" data-value="rainy">Rainy</div>
                <div class="custom-option" data-value="snowy">Snowy</div>
                <div class="custom-option" data-value="windy">Windy</div>
            </div>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Content</label>
      <textarea name="content" rows="3" class="form-textarea" placeholder="Write about your day..." id="diaryContent"></textarea>
    </div>

    <div class="form-group">
      <label>Images (URLs)</label>
      <div class="form-row">
        <input type="text" name="image1" placeholder="Image URL 1" class="form-input image-input">
        <input type="text" name="image2" placeholder="Image URL 2" class="form-input image-input">
      </div>
    </div>

    <div class="form-footer">
      <button type="submit" class="btn-submit" id="submitDiaryBtn">
        <i class="fas fa-paper-plane"></i> Publish
      </button>
    </div>
  </form>
</div>

<style>
  .create-card {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    border: 1px solid #f0f0f0;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    height: 100%; /* Match parent height if grid */
    box-sizing: border-box;
  }

  .card-header {
    padding-bottom: 0.8rem;
    border-bottom: 1px solid #f5f5f5;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .card-title::before {
    content: '';
    width: 4px;
    height: 16px;
    background: #000; /* Black accent for creation */
    border-radius: 2px;
  }

  .btn-reset {
    background: none;
    border: none;
    color: #666;
    font-size: 0.8rem;
    cursor: pointer;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
  }
  .btn-reset:hover {
    background: #f5f5f5;
    color: #333;
  }

  .create-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    flex: 1;
  }

  .form-row {
    display: flex;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .date-group { flex: 2; }
  .mood-group { flex: 1.5; }
  .weather-group { flex: 1.5; }

  label {
    font-size: 0.8rem;
    color: #666;
    font-weight: 500;
  }

  .form-input, .form-textarea {
    padding: 0.6rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: inherit;
    transition: border-color 0.2s;
    width: 100%;
    box-sizing: border-box;
  }

  .form-input:focus, .form-textarea:focus {
    border-color: #000;
    outline: none;
  }

  .form-textarea {
    resize: vertical;
    min-height: 80px;
  }

  /* Custom Select Styles (Reused) */
  .custom-select-wrapper {
    position: relative;
    width: 100%;
  }

  .custom-select-trigger {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0 0.6rem;
    cursor: pointer;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 38px; /* Match input height approx */
    font-size: 0.9rem;
    color: #333;
  }

  .custom-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 6px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 4px;
  }

  .custom-options.hidden { display: none; }

  .custom-option {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.85rem;
    color: #444;
  }

  .custom-option:hover { background: #f5f5f7; }
  .custom-option.selected { background: #f0f7ff; color: #0066cc; }



  .form-footer {
    margin-top: auto;
    display: flex;
    justify-content: flex-end;
  }

  .btn-submit {
    background: #000;
    color: white;
    border: none;
    padding: 0.6rem 1.5rem;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background 0.2s;
  }

  .btn-submit:hover {
    background: #333;
  }
</style>

<script>
  // Elements
  const form = document.getElementById('create-diary-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submitDiaryBtn');
  const resetBtn = document.getElementById('resetDiaryBtn');
  const cardTitle = document.getElementById('diaryCardTitle');
  
  const diaryIdInput = document.getElementById('diaryId') as HTMLInputElement;
  const dateInput = document.getElementById('diary-date-input') as HTMLInputElement;
  const contentInput = document.getElementById('diaryContent') as HTMLTextAreaElement;
  const moodInput = document.getElementById('moodInput') as HTMLInputElement;
  const weatherInput = document.getElementById('weatherInput') as HTMLInputElement;
  const imageInputs = document.querySelectorAll('.image-input');

  // Set default date to now
  if (dateInput) {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    dateInput.value = now.toISOString().slice(0, 16);
  }

  // Custom Select Logic
  function setupSelect(wrapperId: string) {
    const wrapper = document.getElementById(wrapperId);
    if (!wrapper) return;
    
    const trigger = wrapper.querySelector('.custom-select-trigger');
    const options = wrapper.querySelector('.custom-options');
    const input = wrapper.querySelector('input[type="hidden"]') as HTMLInputElement;
    const textSpan = wrapper.querySelector('.current-text');

    trigger?.addEventListener('click', (e) => {
        e.stopPropagation();
        // Close other selects
        document.querySelectorAll('.custom-options').forEach(el => {
            if (el !== options) el.classList.add('hidden');
        });
        options?.classList.toggle('hidden');
    });

    options?.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target.classList.contains('custom-option')) {
            const value = target.getAttribute('data-value');
            const text = target.textContent;
            
            options.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
            target.classList.add('selected');
            
            if (textSpan) textSpan.textContent = text;
            if (input) input.value = value || '';
            
            options.classList.add('hidden');
        }
    });
  }

  setupSelect('moodSelectWrapper');
  setupSelect('weatherSelectWrapper');

  document.addEventListener('click', () => {
    document.querySelectorAll('.custom-options').forEach(el => el.classList.add('hidden'));
  });

  // Submit Logic
  submitBtn?.addEventListener('click', async (e) => {
      e.preventDefault();
      
      if (!dateInput.value) {
          window.showAdminAlert ? window.showAdminAlert('Please select a date', 'error') : alert('Please select a date');
          return;
      }
      if (!moodInput.value) {
          window.showAdminAlert ? window.showAdminAlert('Please select a mood', 'error') : alert('Please select a mood');
          return;
      }
      if (!weatherInput.value) {
          window.showAdminAlert ? window.showAdminAlert('Please select weather', 'error') : alert('Please select weather');
          return;
      }
      if (!contentInput.value.trim()) {
          window.showAdminAlert ? window.showAdminAlert('Please enter content', 'error') : alert('Please enter content');
          return;
      }

      const formData = new FormData();
      formData.append('date', dateInput.value);
      formData.append('content', contentInput.value);
      formData.append('mood', moodInput.value);
      formData.append('weather', weatherInput.value);
      
      const images: string[] = [];
      imageInputs.forEach((input: any) => {
          if (input.value.trim()) images.push(input.value.trim());
      });
      formData.append('images', JSON.stringify(images));

      const isEdit = !!diaryIdInput.value;
      const url = isEdit 
          ? `http://127.0.0.1:8000/api/admin/diaries/${diaryIdInput.value}`
          : `http://127.0.0.1:8000/api/admin/diaries/upload`;
      
      const method = isEdit ? 'PUT' : 'POST';

      try {
          const res = await fetch(url, {
              method: method,
              body: formData
          });

          if (res.ok) {
              resetForm();
              window.dispatchEvent(new CustomEvent('diary-created')); // Refresh list
              if (window.showAdminAlert) {
                  window.showAdminAlert(isEdit ? 'Diary updated!' : 'Diary created!', 'success');
              } else {
                  alert(isEdit ? 'Diary updated!' : 'Diary created!');
              }
          } else {
              if (window.showAdminAlert) {
                  window.showAdminAlert('Operation failed', 'error');
              } else {
                  alert('Operation failed');
              }
          }
      } catch (err) {
          console.error(err);
          if (window.showAdminAlert) {
              window.showAdminAlert('Error occurred', 'error');
          } else {
              alert('Error occurred');
          }
      }
  });

  // Reset Logic
  resetBtn?.addEventListener('click', resetForm);

  function resetForm() {
      form.reset();
      diaryIdInput.value = '';
      if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Publish';
      if (cardTitle) cardTitle.textContent = 'New Diary Entry';
      
      // Reset custom selects
      updateSelect('mood', 'happy', 'Happy');
      updateSelect('weather', 'sunny', 'Sunny');
      
      // Reset date to now
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      dateInput.value = now.toISOString().slice(0, 16);
  }

  function updateSelect(type: string, value: string, text: string) {
      const trigger = document.getElementById(`${type}Trigger`);
      const input = document.getElementById(`${type}Input`) as HTMLInputElement;
      const options = document.getElementById(`${type}Options`);
      
      if (trigger) trigger.querySelector('.current-text')!.textContent = text;
      if (input) input.value = value;
      
      options?.querySelectorAll('.custom-option').forEach(opt => {
          opt.classList.remove('selected');
          if (opt.getAttribute('data-value') === value) opt.classList.add('selected');
          else opt.classList.remove('selected');
      });
  }

  // Edit Listener
  window.addEventListener('edit-diary', (e: any) => {
      const diary = e.detail;
      if (!diary) return;

      diaryIdInput.value = diary.id;
      dateInput.value = diary.date; 
      contentInput.value = diary.content || '';
      
      const mood = diary.mood || 'happy';
      updateSelect('mood', mood, mood.charAt(0).toUpperCase() + mood.slice(1));
      
      const weather = diary.weather || 'sunny';
      updateSelect('weather', weather, weather.charAt(0).toUpperCase() + weather.slice(1));

      // Images
      const images = diary.images || [];
      imageInputs.forEach((input: any, index) => {
          input.value = images[index] || '';
      });

      if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-save"></i> Update';
      if (cardTitle) cardTitle.textContent = 'Edit Diary Entry';
  });